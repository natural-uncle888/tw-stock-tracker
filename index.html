<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>台股損益管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style type="text/tailwindcss">
        [v-cloak] { display: none !important; }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f0f4f8; 
            background-image: linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(to right, #e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
            color: #334155;
            -webkit-user-select: none;
            user-select: none;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .card { @apply bg-white rounded-3xl shadow-[0_10px_40px_-10px_rgba(0,0,0,0.08)] border border-white p-6 md:p-8 mb-8 transition-all duration-300; }
        .input-group { @apply flex flex-col relative; }
        
        /* 按鈕樣式 */
        .btn { @apply h-[50px] px-6 rounded-xl font-bold tracking-wide transition-all duration-200 transform hover:-translate-y-1 active:scale-95 flex items-center justify-center cursor-pointer shadow-md hover:shadow-xl text-base border-0; }
        .btn-primary { @apply bg-gradient-to-br from-blue-600 to-indigo-700 text-white shadow-blue-200; }
        .btn-success { @apply bg-gradient-to-br from-emerald-500 to-teal-600 text-white shadow-emerald-200; }
        .btn-secondary { @apply bg-white text-slate-600 border-2 border-slate-200 hover:border-slate-400 hover:text-slate-800 hover:bg-slate-50; }
        
        .filter-btn { @apply px-4 py-2 rounded-lg text-sm font-bold border-2 border-slate-200 text-slate-500 hover:bg-white hover:text-blue-600 hover:border-blue-300 transition bg-white; }
        .filter-btn.active { @apply bg-blue-50 text-blue-700 border-blue-500; }

        .status-badge { @apply inline-flex items-center justify-center w-5 h-5 rounded-full text-[10px] font-black border ml-1 shadow-sm leading-none; }
        .badge-5m { @apply bg-orange-50 text-orange-600 border-orange-500; }
        .badge-20m { @apply bg-purple-50 text-purple-600 border-purple-600; }
        .text-warning { @apply text-red-600 underline decoration-red-300 decoration-wavy underline-offset-4; }

        .text-up { @apply text-red-600; }
        .text-down { @apply text-green-600; }
        
        .suggestions-list { @apply absolute top-[60px] left-0 z-50 w-full bg-white border-2 border-slate-200 rounded-xl shadow-2xl overflow-hidden max-h-60 overflow-y-auto; }
        .suggestion-item { @apply px-4 py-3 hover:bg-blue-50 cursor-pointer text-gray-800 font-bold border-b border-slate-100 last:border-0 flex justify-between items-center transition-colors; }

        .context-menu { @apply fixed bg-white rounded-xl shadow-2xl border border-slate-100 z-[999] overflow-hidden min-w-[160px] transform scale-100 transition-all duration-100; }
        .context-item { @apply px-4 py-3 text-sm font-bold text-slate-600 hover:bg-blue-50 hover:text-blue-600 cursor-pointer flex items-center gap-2 border-b border-slate-50 last:border-0; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        .tab-switch { @apply hidden md:inline-flex items-center bg-gray-100 rounded-2xl p-1 border border-gray-200 shadow-sm; }
        .tab-btn { @apply relative inline-flex items-center gap-2 px-4 py-2 rounded-2xl font-semibold text-sm text-gray-600 transition-all duration-200; }
        .tab-btn:hover { @apply text-gray-900; }
        .tab-btn.active { @apply bg-white text-gray-900 shadow-sm; }
        .tab-btn.active::after { content: ""; position: absolute; inset: 0; border-radius: 1rem; box-shadow: inset 0 1px 0 rgba(255,255,255,0.6); pointer-events: none; }

        /* Toggle Switch CSS */
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        
        /* Login Backdrop */
        .login-backdrop {
            background-image: linear-gradient(135deg, #f0f4f8 0%, #dbeafe 100%);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }
        
        /* Custom Checkbox */
        .custom-checkbox {
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.15em;
            height: 1.15em;
            border: 2px solid #cbd5e1;
            border-radius: 0.35em;
            display: grid;
            place-content: center;
            transition: all 0.2s;
        }
        .custom-checkbox::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .custom-checkbox:checked::before {
            transform: scale(1);
        }
    
        .btn-tall{
          height: auto !important;
          min-height: 132px !important;
          padding-top: 1.5rem !important;
          padding-bottom: 1.5rem !important;
          flex-direction: column !important;
          justify-content: center !important;
          align-items: center !important;
          gap: 0.75rem !important;
          white-space: normal !important;
          text-align: center !important;
        }

        /* NEW: Sub-Tab Switcher Styles */
        .sub-tab-container { @apply flex p-1 bg-slate-200/50 rounded-xl mb-6 border border-slate-200; }
        .sub-tab-item { @apply flex-1 py-2.5 text-sm font-bold text-slate-500 rounded-lg transition-all duration-200 flex items-center justify-center gap-2 cursor-pointer select-none; }
        .sub-tab-item.active { @apply bg-white text-blue-600 shadow-sm; }
        .sub-tab-item:hover:not(.active) { @apply text-slate-700 bg-slate-200/50; }

    </style>
</head>
<body>

<div id="app" v-cloak class="min-h-screen">
    
    <div v-if="!isLoggedIn" class="fixed inset-0 z-[9999] login-backdrop flex items-center justify-center p-4">
        <div class="bg-white/80 backdrop-blur-xl w-full max-w-sm p-8 rounded-[2rem] shadow-2xl border border-white/50 animate-slide-up">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl mx-auto flex items-center justify-center text-white text-3xl shadow-lg shadow-blue-500/30 mb-4">
                    <i class="fa-solid fa-chart-simple"></i>
                </div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">{{ authMode === 'login' ? '歡迎回來' : '初次設定' }}</h1>
                <p class="text-slate-500 font-bold text-sm mt-2">
                    {{ authMode === 'login' ? '請輸入密碼解鎖您的資產' : '請設定您的帳號密碼以保護資料' }}
                </p>
            </div>

            <div class="space-y-5">
                <div class="input-group">
                    <label class="text-xs font-bold text-slate-500 mb-2 ml-1">帳號</label>
                    <div class="relative flex items-center">
                        <input type="text" v-model="authInput.username" placeholder="User" class="w-full h-[54px] pl-11 pr-4 bg-white border border-slate-200 rounded-2xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all shadow-sm">
                        <i class="fa-solid fa-user absolute left-4 text-slate-400 text-lg"></i>
                    </div>
                </div>

                <div class="input-group">
                    <label class="text-xs font-bold text-slate-500 mb-2 ml-1">密碼</label>
                    <div class="relative flex items-center">
                        <input type="password" v-model="authInput.password" placeholder="••••••" class="w-full h-[54px] pl-11 pr-4 bg-white border border-slate-200 rounded-2xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all shadow-sm">
                        <i class="fa-solid fa-lock absolute left-4 text-slate-400 text-lg"></i>
                    </div>
                </div>

                <div v-if="authMode === 'setup'" class="input-group">
                    <label class="text-xs font-bold text-slate-500 mb-2 ml-1">確認密碼</label>
                    <div class="relative flex items-center">
                        <input type="password" v-model="authInput.confirmPassword" placeholder="••••••" class="w-full h-[54px] pl-11 pr-4 bg-white border border-slate-200 rounded-2xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all shadow-sm">
                        <i class="fa-solid fa-check-double absolute left-4 text-slate-400 text-lg"></i>
                    </div>
                </div>
                
                <div class="flex items-center gap-3 ml-1 mt-1">
                    <input type="checkbox" id="remember-me" v-model="rememberUser" class="custom-checkbox cursor-pointer">
                    <label for="remember-me" class="text-sm font-bold text-slate-600 cursor-pointer select-none">記住帳號</label>
                </div>

                <button @click="handleAuthAction" class="w-full h-[54px] rounded-2xl font-bold text-white bg-blue-600 shadow-xl shadow-blue-500/30 active:scale-[0.98] transition-all text-lg mt-4 flex items-center justify-center gap-2 hover:bg-blue-700">
                    {{ authMode === 'login' ? '登入' : '設定並進入' }} <i class="fa-solid fa-arrow-right"></i>
                </button>
                
                <p v-if="authError" class="text-center text-red-500 text-sm font-bold bg-red-50 py-2 rounded-xl animate-pulse">{{ authError }}</p>

                <div v-if="authMode === 'login'" class="text-center mt-6">
                    <button @click="forgotPassword" class="text-xs text-slate-400 font-bold hover:text-slate-600 underline decoration-slate-300 underline-offset-4">忘記密碼 / 清除重置</button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="isLoggedIn" class="max-w-7xl mx-auto p-4 md:p-8 pb-32" @click="closeContextMenu" @contextmenu.prevent>
        
        <div class="fixed top-0 left-0 w-full z-40 bg-white/90 backdrop-blur-md border-b border-slate-200 px-4 py-3 flex justify-between items-center md:hidden shadow-sm pt-[calc(env(safe-area-inset-top)+12px)]">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 w-10 h-10 rounded-xl flex items-center justify-center text-white shadow-blue-200 shadow-lg">
                    <i class="fa-solid fa-chart-simple text-lg"></i>
                </div>
                <h1 class="text-lg font-black text-slate-800 tracking-tight">台股損益</h1>
            </div>
            <div class="flex gap-2 max-w-[62vw] overflow-x-auto [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden">
                <button @click="showSecurityModal = true" class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center active:bg-slate-200 transition-colors"><i class="fa-solid fa-lock"></i></button>
                <button @click="showSettings = true" class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center active:bg-slate-200"><i class="fa-solid fa-gear"></i></button>
                <button @click="exportData" class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center active:bg-slate-200" title="備份（下載／還原）"><i class="fa-solid fa-download"></i></button>
                <button @click="showGDriveModal = true" class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center active:bg-slate-200" title="Google 雲端備份"><i class="fa-solid fa-cloud"></i></button>
                <button @click="showHelpModal = true" class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 border border-blue-200 flex items-center justify-center active:bg-blue-100 shadow-sm"><i class="fa-solid fa-circle-question text-lg"></i></button>
            </div>
        </div>

        <header class="hidden md:flex flex-col xl:flex-row justify-between items-center mb-8 gap-6 bg-white rounded-3xl p-6 shadow-md border border-slate-100">
            <div class="flex items-center gap-5">
                <div class="bg-gradient-to-br from-blue-600 to-indigo-700 w-14 h-14 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                    <i class="fa-solid fa-chart-simple text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">台股損益管理</h1>
                    <p class="text-sm text-slate-500 font-bold tracking-wider mt-1">SMART TRACKER v4.3 Pro</p>
                </div>
            </div>
            
            <div class="tab-switch" role="tablist" aria-label="主功能分頁">
                <button @click="currentTab = 'inventory'; showStockDetails = false" type="button" role="tab" :aria-selected="currentTab === 'inventory'" :class="['tab-btn', currentTab === 'inventory' ? 'active' : '']">
                    <i class="fa-solid fa-briefcase text-base"></i><span>庫存管理</span>
                </button>
                <button @click="currentTab = 'history'; showStockDetails = false" type="button" role="tab" :aria-selected="currentTab === 'history'" :class="['tab-btn', currentTab === 'history' ? 'active' : '']">
                    <i class="fa-solid fa-file-invoice-dollar text-base"></i><span>歷史帳務</span>
                </button>
            </div>

            <div class="flex gap-3">
                <button @click="showSecurityModal = true" class="btn btn-secondary !h-12 !px-4 !rounded-xl" title="安全性設定"><i class="fa-solid fa-lock text-lg"></i></button>
                <button @click="showSettings = true" class="btn btn-secondary !h-12 !px-4 !rounded-xl" title="費率設定"><i class="fa-solid fa-gear text-lg"></i></button>
                <button @click="exportData" class="btn btn-secondary !h-12 !px-4 !rounded-xl" title="備份"><i class="fa-solid fa-download text-lg"></i></button>
                <button @click="showGDriveModal = true" class="btn btn-secondary !h-12 !px-4 !rounded-xl" title="Google 雲端備份"><i class="fa-solid fa-cloud text-lg"></i></button>
                <button @click="showHelpModal = true" class="btn btn-secondary !h-12 !px-4 !rounded-xl !text-blue-600 !border-blue-200 hover:!bg-blue-50" title="使用說明"><i class="fa-solid fa-circle-question text-lg"></i></button>
            </div>
        </header>

        <div class="h-20 md:hidden"></div>

        <div v-show="currentTab === 'inventory'">
            <div v-if="!showStockDetails">
            <div class="block md:hidden space-y-4 mb-6">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa-solid fa-wallet text-9xl"></i></div>
                    <div class="relative z-10 space-y-5">
                        <div class="flex items-start justify-between gap-4">
                            <div class="min-w-0">
                                <div class="flex items-center gap-2 text-slate-300 text-xs font-bold tracking-wide"><span class="inline-flex items-center gap-2">未實現損益</span></div>
                                <div class="mt-1 text-4xl font-black tracking-tight" :class="totalUnrealizedPnL >= 0 ? 'text-red-400' : 'text-green-400'">
                                    {{ totalUnrealizedPnL >= 0 ? '+' : '' }}{{ formatCurrency(totalUnrealizedPnL) }}
                                </div>
                                <div class="mt-2 text-sm font-black tracking-tight" :class="totalRealizedPnL >= 0 ? 'text-red-200' : 'text-green-200'">
                                    已實現損益：{{ totalRealizedPnL > 0 ? '+' : '' }}{{ formatCurrency(totalRealizedPnL) }}
                                </div>
                                <div class="mt-1 text-[11px] text-slate-300/80 font-semibold">以最新更新股價估算</div>
                            </div>
                            <div class="shrink-0">
                                <div class="inline-flex items-center px-3 py-1.5 rounded-full bg-white/10 border border-white/10 text-xs font-black" :class="totalUnrealizedPnL >= 0 ? 'text-red-200' : 'text-green-200'">
                                    <i class="fa-solid fa-chart-line mr-1 opacity-80"></i>
                                    {{ totalInvestedCost > 0 ? ((totalUnrealizedPnL / totalInvestedCost) * 100).toFixed(2) : 0 }}%
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
                                <div class="flex items-center justify-between"><div class="text-slate-300 text-xs font-bold">持倉總市值</div><i class="fa-solid fa-coins text-white/60"></i></div>
                                <div class="mt-1 text-lg font-black tracking-tight">{{ formatCurrency(estimatedMarketValue) }}</div>
                            </div>
                            <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
                                <div class="flex items-center justify-between"><div class="text-slate-300 text-xs font-bold">總投入成本</div><i class="fa-solid fa-circle-dollar-to-slot text-white/60"></i></div>
                                <div class="mt-1 text-lg font-black tracking-tight text-slate-100">{{ formatCurrency(totalInvestedCost) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <button @click="fetchStockPrices" class="flex-1 btn btn-primary gap-2 disabled:opacity-50 disabled:cursor-not-allowed !h-auto !min-h-[132px] !px-4 !py-6 !flex-col whitespace-normal text-center btn-tall w-full" :disabled="isLoading">
                        <i class="fa-solid fa-rotate text-blue-500" :class="{'fa-spin': isLoading}"></i>
                        {{ isLoading ? '更新中...' : '更新股價' }}
                    </button>
                    <!-- Mobile: Centered label for Global Indices (Night) -->
                    <button @click="fetchGlobalIndices" :disabled="isGlobalLoading" class="flex-1 btn btn-secondary hover:border-purple-300 hover:text-purple-700 hover:bg-purple-50/40 disabled:opacity-50 disabled:cursor-not-allowed !h-auto !min-h-[96px] !px-4 !py-5 !flex-col gap-2 whitespace-normal text-center w-full">
                        <i class="fa-solid fa-globe text-purple-500 text-xl" :class="{'fa-spin': isGlobalLoading}"></i>
                        <div class="flex flex-col items-center leading-tight">
                            <div class="text-base text-slate-800 font-semibold">全球指數（夜）</div>
                            <div class="text-xs text-slate-400 mt-0.5">美股 · 台股夜盤</div>
                        </div>
                    </button>
                    <a href="https://tw.stock.yahoo.com/future" target="_blank" rel="noopener" title="台指期夜盤・美股" class="flex-1 btn btn-secondary gap-2 hover:border-slate-300 hover:bg-slate-50/60 hover:text-slate-700">
                        <i class="fa-solid fa-arrow-up-right-from-square text-slate-500"></i><div class="flex flex-col items-start leading-tight"><div class="flex items-center gap-1 text-slate-800 font-semibold"><span class="text-base">Yahoo 指數</span></div><div class="text-xs text-slate-400 mt-0.5">台指期夜盤・美股</div></div>
                    </a>
                </div>
                <div class="text-center text-xs font-bold">
                    <div class="flex items-center justify-center gap-1" :class="priceUpdateHintClass"><i :class="priceUpdateHintIcon"></i><span>{{ priceUpdateHintText }}</span></div>
                    <div class="text-slate-400 mt-0.5">更新時間: {{ lastUpdateTime || '--' }}</div>
                </div>
            </div>

            <div class="hidden md:grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="card !mb-0 !border-0 shadow-xl relative overflow-hidden group bg-gradient-to-br from-slate-800 via-slate-900 to-black text-white">
                    <div class="absolute -right-6 -top-6 text-white/5 group-hover:text-white/10 transition-colors duration-500"><i class="fa-solid fa-wallet text-[150px]"></i></div>
                    <div class="relative z-10 flex flex-col justify-between h-full">
                        <div><div class="flex items-center gap-2 mb-1"><div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center text-blue-300"><i class="fa-solid fa-sack-dollar"></i></div><h3 class="font-bold text-slate-300 text-sm tracking-wide">持倉總市值</h3></div><p class="text-4xl font-black tracking-tight mt-3 text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-300">{{ formatCurrency(estimatedMarketValue) }}</p></div>
                        <div class="mt-6 pt-4 border-t border-white/10"><div class="flex justify-between items-center text-sm"><span class="text-slate-400 font-bold">總投入成本</span><span class="font-mono font-bold text-slate-200">{{ formatCurrency(totalInvestedCost) }}</span></div><div class="w-full h-1.5 bg-slate-700/50 rounded-full mt-2 overflow-hidden"><div class="h-full bg-blue-500 rounded-full shadow-[0_0_10px_rgba(59,130,246,0.5)]" :style="{ width: totalInvestedCost > 0 ? Math.min((totalInvestedCost / estimatedMarketValue) * 100, 100) + '%' : '0%' }"></div></div></div>
                    </div>
                </div>
                <div class="card !mb-0 !border-0 shadow-xl relative overflow-hidden flex flex-col justify-between" :class="totalUnrealizedPnL >= 0 ? 'bg-gradient-to-br from-red-50 to-white border-2 border-red-100' : 'bg-gradient-to-br from-emerald-50 to-white border-2 border-emerald-100'">
                    <div class="absolute right-0 top-1/2 -translate-y-1/2 text-[120px] opacity-5 pointer-events-none" :class="totalUnrealizedPnL >= 0 ? 'text-red-600' : 'text-emerald-600'"><i class="fa-solid" :class="totalUnrealizedPnL >= 0 ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down'"></i></div>
                    <div><div class="flex items-center gap-2 mb-1"><div class="w-8 h-8 rounded-lg flex items-center justify-center text-white shadow-sm" :class="totalUnrealizedPnL >= 0 ? 'bg-gradient-to-br from-red-500 to-rose-600' : 'bg-gradient-to-br from-emerald-500 to-teal-600'"><i class="fa-solid" :class="totalUnrealizedPnL >= 0 ? 'fa-arrow-up' : 'fa-arrow-down'"></i></div><h3 class="font-bold text-sm tracking-wide" :class="totalUnrealizedPnL >= 0 ? 'text-red-800' : 'text-emerald-800'">未實現損益 (帳面)</h3></div><div class="mt-3 flex items-baseline gap-2"><p class="text-4xl font-black tracking-tight" :class="totalUnrealizedPnL >= 0 ? 'text-red-600 drop-shadow-sm' : 'text-emerald-600 drop-shadow-sm'">{{ totalUnrealizedPnL >= 0 ? '+' : '' }}{{ formatCurrency(totalUnrealizedPnL) }}</p></div></div>
                    <div class="mt-4 flex items-center justify-between bg-white/60 backdrop-blur-sm p-3 rounded-xl border border-white/50 shadow-sm"><span class="text-xs font-bold text-slate-500 uppercase">Return on Investment</span><span class="text-lg font-black px-3 py-0.5 rounded-lg" :class="totalUnrealizedPnL >= 0 ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'">{{ totalInvestedCost > 0 ? ((totalUnrealizedPnL / totalInvestedCost) * 100).toFixed(2) : 0 }}%</span></div>
                </div>
                <div class="card !mb-0 flex flex-col justify-center items-center gap-3">
                    <div class="grid grid-cols-3 gap-4 w-full">
                        <button @click="fetchStockPrices" :disabled="isLoading" class="col-span-1 row-span-2 btn btn-primary disabled:opacity-50 disabled:cursor-not-allowed flex flex-col justify-center items-center gap-3 py-6 btn-tall"><i class="fa-solid fa-rotate text-white/90 text-xl" :class="{'fa-spin': isLoading}"></i><div class="flex flex-col items-center leading-tight"><span class="text-sm" v-if="isLoading">更新中...</span><span class="text-lg font-semibold">更新股價</span></div></button>
                        <button @click="fetchGlobalIndices" :disabled="isGlobalLoading" class="col-span-2 btn btn-secondary disabled:opacity-50 disabled:cursor-not-allowed grid grid-cols-[1fr_auto] items-center px-5 py-4 hover:border-purple-300 hover:text-purple-700 hover:bg-purple-50/40"><div class="flex items-center gap-3 min-w-0 flex-1"><i class="fa-solid fa-globe text-purple-500 text-lg" :class="{'fa-spin': isGlobalLoading}"></i><div class="flex flex-col items-start leading-tight min-w-0 flex-1"><div class="font-semibold text-slate-800 truncate">全球指數（夜）</div><div class="text-xs text-slate-400 mt-0.5 truncate">美股 · 台股夜盤</div></div></div><div class="flex items-center gap-2 shrink-0 ml-3"><i class="fa-solid fa-chevron-right text-slate-300 shrink-0 ml-1"></i></div></button>
                        <a href="https://tw.stock.yahoo.com/future" target="_blank" rel="noopener" title="台指期夜盤・美股" class="col-span-2 btn btn-secondary flex items-center justify-between px-5 py-4 hover:border-slate-300 hover:bg-slate-50/60 hover:text-slate-700"><div class="flex items-center gap-3"><i class="fa-solid fa-arrow-up-right-from-square text-slate-500 text-lg"></i><div class="flex flex-col items-start leading-tight"><div class="font-semibold text-slate-800">Yahoo 指數</div><div class="text-xs text-slate-400 mt-0.5">台指期夜盤・美股</div></div></div><i class="fa-solid fa-chevron-right text-slate-300"></i></a>
                    </div>
                    <div class="text-xs font-bold w-full text-center"><div class="flex items-center justify-center gap-1" :class="priceUpdateHintClass"><i :class="priceUpdateHintIcon"></i><span>{{ priceUpdateHintText }}</span></div><div class="text-slate-400 mt-0.5">{{ lastUpdateTime ? '上次更新: ' + lastUpdateTime : '' }}</div></div>
                </div>
            </div>

            <div v-if="showGlobalIndices" class="card relative z-0 mb-8 border-l-4 border-l-purple-500 bg-slate-50/50">
                <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-extrabold text-slate-700 flex items-center"><i class="fa-solid fa-earth-americas text-purple-500 mr-3"></i> <div class="flex flex-col items-start leading-tight min-w-0"><div class="flex items-center gap-2 text-slate-800 font-semibold min-w-0"><span class="text-base truncate">全球指數（夜）</span></div><div class="text-xs text-slate-400 mt-0.5 truncate">美股 · 台股夜盤</div></div></h2><div class="flex items-center gap-2"><button @click="fetchGlobalIndices" :disabled="isGlobalLoading" class="h-9 px-3 rounded-xl bg-white border border-slate-200 text-slate-700 font-bold shadow-sm hover:bg-slate-50 disabled:opacity-60 disabled:cursor-not-allowed flex items-center gap-2"><i class="fa-solid fa-rotate-right" :class="{'text-purple-500': !isGlobalLoading, 'fa-spin': isGlobalLoading}"></i>更新</button><button @click="showGlobalIndices = false" class="w-9 h-9 rounded-xl hover:bg-slate-200 flex items-center justify-center text-slate-400 hover:text-slate-600 transition"><i class="fa-solid fa-times text-lg"></i></button></div></div><div class="text-center text-xs font-bold mb-5"><div class="flex items-center justify-center gap-1" :class="globalUpdateHintClass"><i :class="globalUpdateHintIcon"></i><span>{{ globalUpdateHintText }}</span></div><div class="text-slate-400 mt-0.5" v-if="globalIndicesLastTs">更新時間: {{ new Date(globalIndicesLastTs).toLocaleString('zh-TW', { hour12: false }) }}</div></div><div class="grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6"><div v-for="idx in globalIndices" :key="idx.symbol" class="bg-white p-4 md:p-5 rounded-2xl shadow-sm border border-slate-200 text-center relative overflow-hidden transition-transform hover:-translate-y-1"><div v-if="idx.kind === 'taiexNight'" class="flex items-start justify-between gap-2 mb-2 text-left"><div class="text-sm text-slate-500 font-bold leading-snug flex-1">{{ idx.name }}</div><button @click="fetchTaiexNightIndex" :disabled="isTaiexNightLoading" class="shrink-0 w-9 h-9 rounded-xl bg-white border border-slate-200 text-slate-600 shadow-sm hover:bg-slate-50 disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center"><i class="fa-solid fa-rotate-right" :class="{'fa-spin': isTaiexNightLoading}"></i></button></div><div v-else class="text-sm text-slate-500 font-bold mb-2">{{ idx.name }}</div><div class="text-2xl font-black text-slate-800 tracking-tight">{{ idx.price }}</div><div class="text-base font-bold mt-2" :class="idx.change >= 0 ? 'text-red-500' : 'text-green-500'">{{ idx.change >= 0 ? '▲' : '▼' }} {{ Math.abs(idx.change).toFixed(2) }} <span class="text-sm ml-1">({{ Math.abs(idx.percent).toFixed(2) }}%)</span></div><div class="absolute bottom-0 left-0 w-full h-1.5" :class="idx.change >= 0 ? 'bg-red-500' : 'bg-green-500'"></div></div></div>
            </div>

            <button @click="showAddModal = true" class="md:hidden fixed bottom-24 right-5 w-16 h-16 bg-blue-600 text-white rounded-full shadow-2xl shadow-blue-500/40 z-50 flex items-center justify-center text-3xl active:scale-90 transition-transform"><i class="fa-solid fa-plus"></i></button>

            <!-- Mobile Add Transaction Modal -->
            <div v-if="showAddModal" @click.self="showAddModal = false" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[95] md:hidden flex items-end justify-center">
                <div class="bg-white w-full rounded-t-[2rem] shadow-2xl flex flex-col overflow-hidden max-h-[92vh] border-t border-slate-200 pb-[calc(env(safe-area-inset-bottom)+16px)] animate-slide-up">
                    <div class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-slate-100 px-4 py-3 flex items-center justify-between">
                        <div class="font-black text-slate-800 text-base flex items-center gap-2">
                            <i class="fa-solid fa-pen-to-square text-blue-600"></i>
                            新增交易
                        </div>
                        <button @click="showAddModal = false" class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center active:bg-slate-200 transition-colors" title="關閉">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="p-4 overflow-y-auto">
<div class="card relative z-10 !pb-10 border-t-4" :class="newTx.type === 'buy' ? 'border-t-blue-500' : 'border-t-rose-500'">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-extrabold text-slate-800 flex items-center">
                        <span class="w-10 h-10 rounded-xl flex items-center justify-center mr-3 text-lg" :class="newTx.type === 'buy' ? 'bg-blue-100 text-blue-600' : 'bg-rose-100 text-rose-600'">
                            <i class="fa-solid" :class="newTx.type === 'buy' ? 'fa-cart-shopping' : 'fa-arrow-right-from-bracket'"></i>
                        </span>
                        新增交易紀錄
                    </h2>
                    <label v-if="newTx.type === 'sell'" class="flex items-center gap-2 text-sm font-bold text-slate-600 cursor-pointer select-none">
                        <input type="checkbox" v-model="newTx.isDayTrade" class="w-4 h-4 accent-rose-600">
                        當沖（賣出稅率 {{ settings.dayTradeTaxRate }}%）
                    </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="input-group">
                        <label class="text-xs font-bold text-slate-500 mb-2 ml-1">交易日期</label>
                        <div class="relative flex items-center">
                            <input type="date" v-model="newTx.date" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm cursor-pointer">
                            <i class="fa-regular fa-calendar-days absolute left-4 text-slate-400 text-lg pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="text-xs font-bold text-slate-500 mb-2 ml-1">交易方向</label>
                        <div class="relative flex items-center">
                            <select v-model="newTx.type" class="w-full h-[50px] pl-11 pr-10 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm appearance-none cursor-pointer">
                                <option value="buy">🟥 買入 / 回補</option>
                                <option value="sell">🟩 賣出 / 融券(做空)</option>
                            </select>
                            <i class="fa-solid fa-right-left absolute left-4 text-slate-400 text-lg pointer-events-none"></i>
                            <i class="fa-solid fa-chevron-down absolute right-4 text-slate-300 text-xs pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="input-group relative">
                        <label class="text-xs font-bold text-slate-500 mb-2 ml-1 flex justify-between">股票代碼 / 名稱 <span v-if="isSearching" class="text-blue-600 text-xs animate-pulse">搜尋中...</span></label>
                        <div class="relative flex items-center">
                            <input type="text" v-model="searchText" @input="lookupStock" placeholder="如: 2330" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm placeholder:text-slate-300 placeholder:font-normal">
                            <i class="fa-solid fa-magnifying-glass absolute left-4 text-slate-400 text-lg pointer-events-none"></i>
                        </div>
                        <div v-if="showSuggestions && suggestions.length > 0" class="suggestions-list !top-[55px]">
                            <div v-for="s in suggestions" :key="s.code" @click="selectSuggestion(s)" class="suggestion-item group">
                                <div>
                                    <span class="font-black text-blue-600 mr-2 w-14 inline-block">{{ s.code }}</span>
                                    <span class="text-slate-700 font-bold">{{ s.name }}</span>
                                    <span v-if="s.isOnline" class="ml-2 text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded font-bold">線上</span>
                                </div>
                                <i class="fa-solid fa-plus text-slate-300 group-hover:text-blue-500"></i>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="text-xs font-bold text-slate-500 mb-2 ml-1">策略分類</label>
                        <div class="relative flex items-center">
                            <select v-model="newTx.category" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm appearance-none cursor-pointer">
                                <option value="core">🛡️ 主力 (長期)</option>
                                <option value="rotation">🔄 輪動 (短期)</option>
                            </select>
                            <i class="fa-solid fa-tag absolute left-4 text-slate-400 text-lg pointer-events-none"></i>
                            <i class="fa-solid fa-chevron-down absolute right-4 text-slate-300 text-xs pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="text-xs font-bold text-slate-500 mb-2 ml-1">成交價格</label>
                        <div class="relative flex items-center">
                            <input type="number" step="0.01" v-model.number="newTx.price" placeholder="0.00" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm placeholder:text-slate-300">
                            <i class="fa-solid fa-dollar-sign absolute left-4 text-slate-400 text-base pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="text-xs font-bold text-slate-500 mb-2 ml-1">成交股數</label>
                        <div class="relative flex items-center">
                            <input type="number" v-model.number="newTx.qty" placeholder="1000" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm placeholder:text-slate-300">
                            <i class="fa-solid fa-cubes absolute left-4 text-slate-400 text-base pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="input-group justify-end">
                        <label class="text-xs font-bold text-slate-500 mb-2 ml-1 opacity-0 select-none">Action</label>
                        <button @click="addTransaction" class="w-full h-[50px] rounded-xl font-bold text-white shadow-lg active:scale-[0.98] transition-all text-lg flex items-center justify-center gap-2" :class="newTx.type === 'buy' ? 'bg-blue-600 hover:bg-blue-700 shadow-blue-500/30' : 'bg-rose-600 hover:bg-rose-700 shadow-rose-500/30'">
                            <i class="fa-solid fa-check"></i>
                            {{ newTx.type === 'buy' ? '確認新增買入 / 回補' : '確認新增賣出 / 做空' }}
                        </button>
                        <div v-if="newTx.type === 'sell'" class="mt-2 text-[11px] text-slate-400 font-bold leading-relaxed">提示：若賣出股數大於現有庫存，系統會自動視為「融券/做空」並出現負庫存（空單）。</div>
                        <button type="button" @click="showAddModal = false"
                            class="mt-3 w-full h-[46px] rounded-xl font-bold bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 active:scale-[0.98] transition">
                            取消 / 關閉
                        </button>
                    </div>
                </div>
            </div>
                    </div>
                </div>
            </div>

            <div class="hidden md:block card relative z-10 !pb-10 border-t-4" :class="newTx.type === 'buy' ? 'border-t-blue-500' : 'border-t-rose-500'">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-extrabold text-slate-800 flex items-center">
                        <span class="w-10 h-10 rounded-xl flex items-center justify-center mr-3 text-lg" :class="newTx.type === 'buy' ? 'bg-blue-100 text-blue-600' : 'bg-rose-100 text-rose-600'">
                            <i class="fa-solid" :class="newTx.type === 'buy' ? 'fa-cart-shopping' : 'fa-arrow-right-from-bracket'"></i>
                        </span>
                        新增交易紀錄
                    </h2>
                    <label v-if="newTx.type === 'sell'" class="flex items-center gap-2 text-sm font-bold text-slate-600 cursor-pointer select-none">
                        <input type="checkbox" v-model="newTx.isDayTrade" class="w-4 h-4 accent-rose-600">
                        當沖（賣出稅率 {{ settings.dayTradeTaxRate }}%）
                    </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="input-group">
                        <label class="text-xs font-bold text-slate-500 mb-2 ml-1">交易日期</label>
                        <div class="relative flex items-center">
                            <input type="date" v-model="newTx.date" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm cursor-pointer">
                            <i class="fa-regular fa-calendar-days absolute left-4 text-slate-400 text-lg pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="text-xs font-bold text-slate-500 mb-2 ml-1">交易方向</label>
                        <div class="relative flex items-center">
                            <select v-model="newTx.type" class="w-full h-[50px] pl-11 pr-10 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm appearance-none cursor-pointer">
                                <option value="buy">🟥 買入 / 回補</option>
                                <option value="sell">🟩 賣出 / 融券(做空)</option>
                            </select>
                            <i class="fa-solid fa-right-left absolute left-4 text-slate-400 text-lg pointer-events-none"></i>
                            <i class="fa-solid fa-chevron-down absolute right-4 text-slate-300 text-xs pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="input-group relative">
                        <label class="text-xs font-bold text-slate-500 mb-2 ml-1 flex justify-between">股票代碼 / 名稱 <span v-if="isSearching" class="text-blue-600 text-xs animate-pulse">搜尋中...</span></label>
                        <div class="relative flex items-center">
                            <input type="text" v-model="searchText" @input="lookupStock" placeholder="如: 2330" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm placeholder:text-slate-300 placeholder:font-normal">
                            <i class="fa-solid fa-magnifying-glass absolute left-4 text-slate-400 text-lg pointer-events-none"></i>
                        </div>
                        <div v-if="showSuggestions && suggestions.length > 0" class="suggestions-list !top-[55px]">
                            <div v-for="s in suggestions" :key="s.code" @click="selectSuggestion(s)" class="suggestion-item group">
                                <div>
                                    <span class="font-black text-blue-600 mr-2 w-14 inline-block">{{ s.code }}</span>
                                    <span class="text-slate-700 font-bold">{{ s.name }}</span>
                                    <span v-if="s.isOnline" class="ml-2 text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded font-bold">線上</span>
                                </div>
                                <i class="fa-solid fa-plus text-slate-300 group-hover:text-blue-500"></i>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="text-xs font-bold text-slate-500 mb-2 ml-1">策略分類</label>
                        <div class="relative flex items-center">
                            <select v-model="newTx.category" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm appearance-none cursor-pointer">
                                <option value="core">🛡️ 主力 (長期)</option>
                                <option value="rotation">🔄 輪動 (短期)</option>
                            </select>
                            <i class="fa-solid fa-tag absolute left-4 text-slate-400 text-lg pointer-events-none"></i>
                            <i class="fa-solid fa-chevron-down absolute right-4 text-slate-300 text-xs pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="text-xs font-bold text-slate-500 mb-2 ml-1">成交價格</label>
                        <div class="relative flex items-center">
                            <input type="number" step="0.01" v-model.number="newTx.price" placeholder="0.00" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm placeholder:text-slate-300">
                            <i class="fa-solid fa-dollar-sign absolute left-4 text-slate-400 text-base pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="text-xs font-bold text-slate-500 mb-2 ml-1">成交股數</label>
                        <div class="relative flex items-center">
                            <input type="number" v-model.number="newTx.qty" placeholder="1000" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm placeholder:text-slate-300">
                            <i class="fa-solid fa-cubes absolute left-4 text-slate-400 text-base pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="input-group justify-end">
                        <label class="text-xs font-bold text-slate-500 mb-2 ml-1 opacity-0 select-none">Action</label>
                        <button @click="addTransaction" class="w-full h-[50px] rounded-xl font-bold text-white shadow-lg active:scale-[0.98] transition-all text-lg flex items-center justify-center gap-2" :class="newTx.type === 'buy' ? 'bg-blue-600 hover:bg-blue-700 shadow-blue-500/30' : 'bg-rose-600 hover:bg-rose-700 shadow-rose-500/30'">
                            <i class="fa-solid fa-check"></i>
                            {{ newTx.type === 'buy' ? '確認新增買入 / 回補' : '確認新增賣出 / 做空' }}
                        </button>
                        <div v-if="newTx.type === 'sell'" class="mt-2 text-[11px] text-slate-400 font-bold leading-relaxed">提示：若賣出股數大於現有庫存，系統會自動視為「融券/做空」並出現負庫存（空單）。</div>
                    </div>
                </div>
            </div>

            <div class="space-y-4"><div class="flex flex-col md:flex-row justify-between items-center px-2"><h2 class="text-xl font-bold text-slate-700 flex items-center"><i class="fa-solid fa-layer-group text-slate-400 mr-3"></i> 目前持倉</h2><div class="flex w-full md:w-auto gap-2 mt-4 md:mt-0 bg-white p-1.5 rounded-xl shadow-sm border border-slate-200"><button @click="filter = 'all'" :class="filter==='all' ? 'active' : ''" class="filter-btn flex-1 !py-3 !text-base md:!px-8 md:!text-lg md:min-w-[100px]">全部</button><button @click="filter = 'core'" :class="filter==='core' ? 'active' : ''" class="filter-btn flex-1 !py-3 !text-base md:!px-8 md:!text-lg md:min-w-[100px]">主力</button><button @click="filter = 'rotation'" :class="filter==='rotation' ? 'active' : ''" class="filter-btn flex-1 !py-3 !text-base md:!px-8 md:!text-lg md:min-w-[100px]">輪動</button></div></div><div v-if="holdings.length === 0" class="text-center py-24 bg-white rounded-3xl border-2 border-dashed border-slate-300 text-slate-400"><i class="fa-solid fa-box-open text-6xl mb-4 opacity-30"></i><p class="font-bold text-lg">尚無庫存資料</p></div><div v-else class="grid grid-cols-1 gap-5"><div v-for="stock in filteredHoldings" :key="stock.code" @contextmenu.prevent="openContextMenu($event, stock)" class="bg-white rounded-2xl p-6 shadow-[0_4px_20px_-5px_rgba(0,0,0,0.05)] border-2 border-transparent hover:border-blue-200 transition-all duration-300 group cursor-default relative"><div class="absolute top-2 right-4 text-[10px] text-slate-300 hidden md:block group-hover:text-slate-400"><i class="fa-solid fa-mouse-pointer mr-1"></i>右鍵設定狀態</div><div class="flex flex-col lg:flex-row gap-6 items-center"><div class="flex items-center gap-5 w-full lg:w-1/4"><div class="w-1.5 h-16 rounded-full" :class="stock.category === 'core' ? 'bg-blue-500' : 'bg-indigo-500'"></div><div class="bg-slate-50 px-2 py-3 rounded-xl text-center min-w-[110px] border border-slate-200 flex flex-col justify-center"><div class="text-xl font-black text-slate-800 leading-tight"><button type="button" @click="openStockDetails(stock)" class="text-left hover:underline underline-offset-4" :class="stock.isWarning ? 'text-warning' : ''">{{ stock.name }}</button></div><div class="text-xs font-bold text-slate-500 mt-1 flex items-center justify-center gap-1"><span>{{ stock.code }}</span><span v-if="stock.isWarning" title="注意/警示股" class="animate-pulse"><i class="fa-solid fa-triangle-exclamation text-red-500"></i></span></div></div><div><span v-if="stock.category === 'core'" class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold">主力</span><span v-else class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-1 rounded font-bold">輪動</span><div class="text-slate-500 text-sm mt-1 font-medium">持有 <strong class="text-slate-800 text-xl mx-1">{{ formatCurrency(stock.qty) }}</strong> 股</div></div></div><div class="flex-1 grid grid-cols-2 md:grid-cols-5 gap-4 w-full bg-slate-50/50 p-4 rounded-xl border border-slate-200"><div class="text-center md:text-left"><div class="text-xs text-slate-400 mb-1 font-bold uppercase">現價</div><div class="font-bold text-blue-600 text-xl">{{ stock.currentPrice || '-' }}</div></div><div class="text-center md:text-left"><div class="text-xs text-slate-400 mb-1 font-bold uppercase">購買均價</div><div class="font-bold text-slate-700 text-xl">{{ stock.buyAvgPrice ? stock.buyAvgPrice.toFixed(2) : '-' }}</div></div><div class="text-center md:text-left"><div class="text-xs text-slate-400 mb-1 font-bold uppercase">未實現損益</div><div class="font-black text-xl" :class="stock.unrealizedPnL >= 0 ? 'text-up' : 'text-down'">{{ stock.unrealizedPnL >= 0 ? '+' : '' }}{{ formatCurrency(stock.unrealizedPnL) }}</div></div><div class="text-center md:text-left"><div class="text-xs text-slate-400 mb-1 font-bold uppercase">已實現損益</div><div class="font-black text-xl" :class="stock.realizedPnL >= 0 ? 'text-up' : 'text-down'">{{ stock.realizedPnL > 0 ? '+' : '' }}{{ formatCurrency(stock.realizedPnL) }}</div></div><div class="text-center md:text-left"><div class="text-xs text-slate-400 mb-1 font-bold uppercase">報酬率</div><div class="font-black text-xl" :class="stock.roi >= 0 ? 'text-up' : 'text-down'">{{ stock.roi }}%</div></div></div><div class="w-full lg:w-auto flex gap-3"><button @click="openStockDetails(stock)" class="btn btn-secondary w-full lg:w-auto shadow-sm"><i class="fa-solid fa-pen-to-square mr-2"></i> 編輯</button><button @click="openSellModal(stock)" class="btn btn-secondary w-full lg:w-auto !border-red-200 !text-red-500 hover:!bg-red-500 hover:!text-white shadow-sm"><i class="fa-solid fa-arrow-right-from-bracket mr-2"></i> 賣出</button></div></div></div></div></div>
            </div>
            
            <div v-else class="space-y-6"><div class="flex items-center justify-between px-2"><div class="flex items-center gap-3"><button type="button" @click="closeStockDetails" class="btn btn-secondary !rounded-xl !px-4 !py-3"><i class="fa-solid fa-arrow-left mr-2"></i>返回</button><div><div class="text-xl font-black text-slate-800 leading-tight">{{ selectedStock?.name }} <span class="text-slate-400 font-bold">({{ selectedStock?.code }})</span></div><div class="text-sm text-slate-500 font-medium mt-1">交易明細（僅顯示買入紀錄）</div></div></div></div><div class="card !p-0 overflow-hidden"><div class="px-6 py-4 border-b border-slate-200 bg-slate-50"><h3 class="text-base font-extrabold text-slate-700 flex items-center gap-2"><i class="fa-solid fa-receipt text-slate-400"></i> 購買明細</h3></div><div v-if="selectedStockBuys.length === 0" class="text-center py-16 text-slate-400"><i class="fa-solid fa-circle-info text-3xl mb-3 opacity-50"></i><div class="font-bold">沒有買入紀錄</div></div><div v-else><div class="md:hidden divide-y divide-slate-100"><div v-for="(row, idx) in selectedStockBuys" :key="idx" class="px-6 py-5"><div class="flex items-center justify-between"><div class="text-sm font-extrabold text-slate-700">{{ row.date }}</div><div class="text-xs font-bold text-slate-500">買入</div></div><div class="mt-3 grid grid-cols-3 gap-3 text-sm"><div class="bg-slate-50 rounded-xl p-3 border border-slate-200"><div class="text-[11px] font-bold text-slate-500 mb-1">購買股數</div><div class="text-base font-black text-slate-800">{{ formatCurrency(row.qty) }}</div></div><div class="bg-slate-50 rounded-xl p-3 border border-slate-200"><div class="text-[11px] font-bold text-slate-500 mb-1">單價</div><div class="text-base font-black text-slate-800">{{ formatPrice2(row.price) }}</div></div><div class="bg-slate-50 rounded-xl p-3 border border-slate-200"><div class="text-[11px] font-bold text-slate-500 mb-1">小計</div><div class="text-base font-black text-slate-800">{{ formatCurrency(row.price * row.qty) }}</div></div></div><div class="flex justify-end gap-2 mt-4"><button type="button" @click="openEditBuyModal(row)" class="px-3 py-2 rounded-lg text-xs font-black bg-white border-2 border-slate-200 text-slate-600 hover:bg-slate-50 hover:border-slate-400 transition"><i class="fa-solid fa-pen-to-square mr-1"></i> 編輯</button><button type="button" @click="deleteTransaction(row.id)" class="px-3 py-2 rounded-lg text-xs font-black bg-white border-2 border-red-200 text-red-500 hover:bg-red-50 hover:border-red-400 transition"><i class="fa-solid fa-trash-can mr-1"></i> 刪除</button></div></div></div><div class="hidden md:block overflow-x-auto"><table class="w-full min-w-[720px]"><thead class="bg-slate-50 text-slate-500 text-xs uppercase tracking-wider"><tr><th class="px-6 py-4 text-left font-bold">購買日期</th><th class="px-6 py-4 text-right font-bold">購買股數</th><th class="px-6 py-4 text-right font-bold">單價</th><th class="px-6 py-4 text-right font-bold">小計</th><th class="px-6 py-4 text-right font-bold">操作</th></tr></thead><tbody><tr v-for="(row, idx) in selectedStockBuys" :key="idx" class="border-t border-slate-100 hover:bg-slate-50/60"><td class="px-6 py-4 font-bold text-slate-700">{{ row.date }}</td><td class="px-6 py-4 text-right font-bold text-slate-700">{{ formatCurrency(row.qty) }}</td><td class="px-6 py-4 text-right font-bold text-slate-700">{{ formatPrice2(row.price) }}</td><td class="px-6 py-4 text-right font-black text-slate-800">{{ formatCurrency(row.price * row.qty) }}</td><td class="px-6 py-4 text-right"><div class="flex justify-end gap-2"><button type="button" @click="openEditBuyModal(row)" class="px-3 py-2 rounded-lg text-xs font-black bg-white border-2 border-slate-200 text-slate-600 hover:bg-slate-50 hover:border-slate-400 transition"><i class="fa-solid fa-pen-to-square"></i></button><button type="button" @click="deleteTransaction(row.id)" class="px-3 py-2 rounded-lg text-xs font-black bg-white border-2 border-red-200 text-red-500 hover:bg-red-50 hover:border-red-400 transition"><i class="fa-solid fa-trash-can"></i></button></div></td></tr></tbody></table></div></div></div></div>
        </div>

        <div v-show="currentTab === 'history'">
            
            <div class="sub-tab-container">
                <div @click="historyMode = 'list'" :class="['sub-tab-item', historyMode === 'list' ? 'active' : '']">
                    <i class="fa-solid fa-list-ul mr-2"></i> 交易流水帳
                </div>
                <div @click="historyMode = 'analysis'" :class="['sub-tab-item', historyMode === 'analysis' ? 'active' : '']">
                    <i class="fa-solid fa-chart-pie mr-2"></i> 已實現損益分析
                </div>
            </div>

            <div v-if="historyMode === 'list'">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><div class="text-xs text-slate-400 font-bold mb-1">區間已實現損益</div><div class="text-2xl font-black" :class="filteredStats.realizedPnL >= 0 ? 'text-up' : 'text-down'">{{ filteredStats.realizedPnL > 0 ? '+' : '' }}{{ formatCurrency(filteredStats.realizedPnL) }}</div></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><div class="text-xs text-slate-400 font-bold mb-1">區間交易費用</div><div class="text-xl font-bold text-slate-600">{{ formatCurrency(filteredStats.fees) }}</div></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><div class="text-xs text-slate-400 font-bold mb-1">區間買入總額</div><div class="text-xl font-bold text-slate-800">{{ formatCurrency(filteredStats.buyAmount) }}</div></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><div class="text-xs text-slate-400 font-bold mb-1">區間賣出總額</div><div class="text-xl font-bold text-slate-800">{{ formatCurrency(filteredStats.sellAmount) }}</div></div>
                </div>
                
                <div class="card !p-5 !mb-6">
                    <div class="hidden md:flex flex-col xl:flex-row gap-4 items-center justify-between">
                        <div class="flex gap-3 overflow-x-auto w-full xl:w-auto pb-2 xl:pb-0 scrollbar-hide">
                            <button v-for="mode in ['today','yesterday','week','month','all']" @click="setDateFilter(mode)" class="filter-btn whitespace-nowrap px-6 py-3 text-sm" :class="{ active: dateFilterMode === mode}">{{ {'today':'今日','yesterday':'昨日','week':'近一週','month':'近一月','all':'全部'}[mode] }}</button>
                        </div>
                        <div class="flex gap-3 w-full xl:w-auto">
                            <div class="flex items-center gap-3 bg-white px-5 py-3 rounded-xl border-2 border-slate-200 shadow-sm flex-1"><i class="fa-regular fa-calendar text-slate-400"></i><input type="date" v-model="filterStart" class="bg-transparent text-sm font-bold text-slate-600 outline-none w-32 cursor-pointer"><span class="text-slate-300 font-bold">➜</span><input type="date" v-model="filterEnd" class="bg-transparent text-sm font-bold text-slate-600 outline-none w-32 cursor-pointer"></div>
                            <button @click="triggerClearHistory" class="btn bg-gradient-to-r from-rose-500 to-red-600 text-white !shadow-none !h-auto !px-6 !py-3 !text-sm !rounded-full whitespace-nowrap active:opacity-90"><i class="fa-solid fa-trash-can mr-2"></i> 清空</button>
                        </div>
                    </div>
                    <div class="md:hidden flex flex-col gap-4">
                        <div class="relative">
                            <select v-model="dateFilterMode" @change="setDateFilter(dateFilterMode)" class="w-full h-12 pl-4 pr-10 bg-slate-100 border-2 border-slate-200 rounded-xl text-slate-700 font-bold appearance-none outline-none focus:border-blue-500 transition-colors"><option value="today">📅 今日</option><option value="yesterday">⏮️ 昨日</option><option value="week">🗓️ 近一週</option><option value="month">🈷️ 近一月</option><option value="all">♾️ 全部</option></select>
                            <div class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"><i class="fa-solid fa-chevron-down"></i></div>
                        </div>
                        <div class="flex gap-2 items-center bg-slate-50 p-2 rounded-xl border border-slate-200"><input type="date" v-model="filterStart" class="bg-transparent text-sm font-bold text-slate-600 outline-none w-full text-center"><span class="text-slate-300 font-bold">➜</span><input type="date" v-model="filterEnd" class="bg-transparent text-sm font-bold text-slate-600 outline-none w-full text-center"></div>
                        <button @click="triggerClearHistory" class="btn bg-gradient-to-r from-rose-500 to-red-600 text-white !shadow-none w-2/3 mx-auto !h-12 !text-sm !rounded-full active:scale-95 transition-transform"><i class="fa-solid fa-trash-can mr-2"></i> 清空所有紀錄</button>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-4">
                    <div class="flex gap-2">
                        <button @click="historyTypeFilter = (historyTypeFilter === 'buy' ? 'all' : 'buy')" class="px-4 py-2 rounded-xl text-sm font-bold border transition" :class="historyTypeFilter === 'buy' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-700 border-slate-200 hover:bg-slate-50'">買入</button>
                        <button @click="historyTypeFilter = (historyTypeFilter === 'sell' ? 'all' : 'sell')" class="px-4 py-2 rounded-xl text-sm font-bold border transition" :class="historyTypeFilter === 'sell' ? 'bg-rose-600 text-white border-rose-600' : 'bg-white text-slate-700 border-slate-200 hover:bg-slate-50'">賣出</button>
                    </div>
                    <button v-if="historyTypeFilter !== 'all'" @click="historyTypeFilter = 'all'" class="text-xs font-bold text-slate-500 hover:text-slate-700">清除篩選</button>
                </div>

                <div class="md:hidden space-y-4">
                    <div v-for="tx in displayedHistoryTransactions" :key="tx.id" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                        <div class="flex justify-between items-start mb-3">
                            <div class="text-xs font-bold text-slate-400 flex items-center gap-2"><i class="fa-regular fa-calendar"></i> {{ tx.date }}</div>
                            <div class="flex items-center gap-2"><button @click="openEditTxModal(tx)" class="text-slate-300 hover:text-slate-700 p-1" title="編輯"><i class="fa-solid fa-pen-to-square"></i></button><button @click="deleteTransaction(tx.id)" class="text-slate-300 hover:text-red-500 p-1"><i class="fa-solid fa-trash-can"></i></button></div>
                        </div>
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-3"><span class="px-2.5 py-1 rounded-lg text-xs font-black" :class="tx.type === 'buy' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'">{{ txTypeLabel(tx) }}</span><div><div class="font-black text-slate-800 text-lg leading-tight">{{ tx.name }}</div><div class="text-[10px] font-bold text-slate-400">{{ tx.code }}</div></div></div>
                            <div class="text-right"><div class="font-black text-lg text-slate-800">{{ formatCurrency(tx.totalAmount) }}</div><div class="text-[10px] font-bold text-slate-400">總金額</div></div>
                        </div>
                        <div class="bg-slate-50 rounded-xl p-3 flex justify-between items-center border border-slate-100">
                            <div class="text-xs font-bold text-slate-600">{{ tx.price }} <span class="text-slate-400 mx-1">x</span> {{ formatCurrency(tx.qty) }} <span class="text-slate-400 text-[10px] ml-1">(費 {{formatCurrency(tx.fee + (tx.tax||0))}})</span></div>
                            <div v-if="tx.realizedPnL !== null" class="font-black text-base" :class="tx.realizedPnL >= 0 ? 'text-up' : 'text-down'">{{ tx.realizedPnL > 0 ? '+' : '' }}{{ formatCurrency(tx.realizedPnL) }}</div>
                            <div v-else class="text-slate-300 font-bold text-sm">-</div>
                        </div>
                    </div>
                    <div v-if="displayedHistoryTransactions.length === 0" class="text-center py-12 text-slate-400 font-bold bg-white rounded-3xl border-2 border-dashed border-slate-200">此區間無交易紀錄</div>
                </div>

                <div class="hidden md:block card p-0 overflow-hidden border-0">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead><tr class="bg-slate-100 text-slate-500 border-b border-slate-200"><th class="p-5 pl-8 whitespace-nowrap font-bold">日期</th><th class="p-5 whitespace-nowrap font-bold">股名</th><th class="p-5 whitespace-nowrap font-bold">買賣</th><th class="p-5 text-right whitespace-nowrap font-bold">價格</th><th class="p-5 text-right whitespace-nowrap font-bold">股數</th><th class="p-5 text-right whitespace-nowrap font-bold">費用</th><th class="p-5 text-right whitespace-nowrap font-bold">總金額</th><th class="p-5 text-right whitespace-nowrap font-bold">損益</th><th class="p-5 text-center whitespace-nowrap font-bold">操作</th></tr></thead>
                            <tbody class="divide-y divide-slate-100">
                                <tr v-for="tx in displayedHistoryTransactions" :key="tx.id" class="hover:bg-slate-50 transition bg-white">
                                    <td class="p-5 pl-8 text-slate-600 font-bold whitespace-nowrap">{{ tx.date }}</td>
                                    <td class="p-5 whitespace-nowrap"><div class="font-bold text-slate-800 text-base">{{ tx.name }}</div><div class="text-xs text-slate-400 font-bold">{{ tx.code }}</div></td>
                                    <td class="p-5 whitespace-nowrap"><span class="px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm" :class="tx.type === 'buy' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'">{{ txTypeLabel(tx) }}</span></td>
                                    <td class="p-5 text-right font-bold text-slate-600">{{ tx.price }}</td><td class="p-5 text-right text-slate-600 font-medium">{{ formatCurrency(tx.qty) }}</td><td class="p-5 text-right text-slate-400 text-xs font-medium">{{ formatCurrency(tx.fee + (tx.tax || 0)) }}</td>
                                    <td class="p-5 text-right font-bold text-slate-800">{{ formatCurrency(tx.totalAmount) }}</td>
                                    <td class="p-5 text-right font-black text-base"><span v-if="tx.realizedPnL !== null" :class="tx.realizedPnL >= 0 ? 'text-up' : 'text-down'">{{ tx.realizedPnL > 0 ? '+' : '' }}{{ formatCurrency(tx.realizedPnL) }}</span><span v-else class="text-slate-300">-</span></td>
                                    <td class="p-5 text-center"><div class="flex items-center justify-center gap-2"><button @click="openEditTxModal(tx)" class="text-slate-300 hover:text-slate-700 hover:bg-slate-100 p-2 rounded-lg transition" title="編輯"><i class="fa-solid fa-pen-to-square"></i></button><button @click="deleteTransaction(tx.id)" class="text-slate-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition" title="刪除"><i class="fa-solid fa-trash-can"></i></button></div></td>
                                </tr>
                                <tr v-if="displayedHistoryTransactions.length === 0"><td colspan="9" class="p-12 text-center text-slate-400 font-bold">此區間無交易紀錄</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div v-if="historyMode === 'analysis'">
                
                <div class="card !p-5 !mb-6">
                    <div class="hidden md:flex flex-col xl:flex-row gap-4 items-center justify-between">
                        <div class="flex gap-3 overflow-x-auto w-full xl:w-auto pb-2 xl:pb-0 scrollbar-hide">
                            <button v-for="mode in ['today','yesterday','week','month','all']" @click="setDateFilter(mode)" class="filter-btn whitespace-nowrap px-6 py-3 text-sm" :class="{ active: dateFilterMode === mode}">{{ {'today':'今日','yesterday':'昨日','week':'近一週','month':'近一月','all':'全部'}[mode] }}</button>
                        </div>
                        <div class="flex gap-3 w-full xl:w-auto">
                            <div class="flex items-center gap-3 bg-white px-5 py-3 rounded-xl border-2 border-slate-200 shadow-sm flex-1"><i class="fa-regular fa-calendar text-slate-400"></i><input type="date" v-model="filterStart" class="bg-transparent text-sm font-bold text-slate-600 outline-none w-32 cursor-pointer"><span class="text-slate-300 font-bold">➜</span><input type="date" v-model="filterEnd" class="bg-transparent text-sm font-bold text-slate-600 outline-none w-32 cursor-pointer"></div>
                        </div>
                    </div>
                    <div class="md:hidden flex flex-col gap-4">
                        <div class="relative">
                            <select v-model="dateFilterMode" @change="setDateFilter(dateFilterMode)" class="w-full h-12 pl-4 pr-10 bg-slate-100 border-2 border-slate-200 rounded-xl text-slate-700 font-bold appearance-none outline-none focus:border-blue-500 transition-colors">
                                <option value="today">📅 今日</option><option value="yesterday">⏮️ 昨日</option><option value="week">🗓️ 近一週</option><option value="month">🈷️ 近一月</option><option value="all">♾️ 全部</option>
                            </select>
                            <div class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"><i class="fa-solid fa-chevron-down"></i></div>
                        </div>
                        <div class="flex gap-2 items-center bg-slate-50 p-2 rounded-xl border border-slate-200">
                            <input type="date" v-model="filterStart" class="bg-transparent text-sm font-bold text-slate-600 outline-none w-full text-center">
                            <span class="text-slate-300 font-bold">➜</span>
                            <input type="date" v-model="filterEnd" class="bg-transparent text-sm font-bold text-slate-600 outline-none w-full text-center">
                        </div>
                    </div>
                </div>

                <div v-if="realizedAnalysisList.length === 0" class="text-center py-24 bg-white rounded-3xl border-2 border-dashed border-slate-300 text-slate-400">
                    <i class="fa-solid fa-chart-pie text-6xl mb-4 opacity-30"></i>
                    <p class="font-bold text-lg">此區間內無已實現損益資料</p>
                </div>

                <div class="md:hidden space-y-4">
                    <div v-for="item in realizedAnalysisList" :key="item.code" @click="openRealizedDetail(item.code)" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:border-blue-300 cursor-pointer active:bg-blue-50 transition-colors">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center font-bold text-xs">{{ item.code }}</div>
                                <div><div class="font-black text-slate-800 text-lg">{{ item.name }}</div><div class="text-xs text-slate-400 font-bold">最新賣出: {{ item.latestDate }}</div></div>
                            </div>
                            <div class="text-right">
                                <div class="font-black text-xl" :class="item.totalPnL >= 0 ? 'text-up' : 'text-down'">{{ item.totalPnL > 0 ? '+' : '' }}{{ formatCurrency(item.totalPnL) }}</div>
                                <div class="text-xs font-bold text-slate-400">區間損益</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100">
                             <div><div class="text-[10px] text-slate-400 font-bold">平均賣出價</div><div class="font-bold text-slate-700">{{ formatPrice2(item.avgPrice) }}</div></div>
                             <div class="text-right"><div class="text-[10px] text-slate-400 font-bold">報酬率 (ROI)</div><div class="font-bold" :class="item.roi >= 0 ? 'text-up' : 'text-down'">{{ item.roi }}%</div></div>
                        </div>
                    </div>
                </div>

                <div class="hidden md:block card p-0 overflow-hidden border-0" v-if="realizedAnalysisList.length > 0">
                    <table class="w-full text-left text-sm">
                        <thead><tr class="bg-blue-50/50 text-slate-500 border-b border-blue-100"><th class="p-5 pl-8 font-bold">股票名稱</th><th class="p-5 text-right font-bold">最新賣出日期</th><th class="p-5 text-right font-bold">累計賣出股數</th><th class="p-5 text-right font-bold">平均賣出價</th><th class="p-5 text-right font-bold">區間總損益</th><th class="p-5 text-right font-bold">報酬率</th><th class="p-5 text-center font-bold">明細</th></tr></thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="item in realizedAnalysisList" :key="item.code" @click="openRealizedDetail(item.code)" class="hover:bg-blue-50/30 cursor-pointer transition bg-white group">
                                <td class="p-5 pl-8"><div class="font-bold text-slate-800 text-base group-hover:text-blue-600 transition-colors">{{ item.name }} <span class="text-xs text-slate-400 ml-1 font-normal">{{ item.code }}</span></div></td>
                                <td class="p-5 text-right font-bold text-slate-600">{{ item.latestDate }}</td>
                                <td class="p-5 text-right font-bold text-slate-600">{{ formatCurrency(item.totalQty) }}</td>
                                <td class="p-5 text-right font-bold text-slate-600">{{ formatPrice2(item.avgPrice) }}</td>
                                <td class="p-5 text-right font-black text-lg" :class="item.totalPnL >= 0 ? 'text-up' : 'text-down'">{{ item.totalPnL > 0 ? '+' : '' }}{{ formatCurrency(item.totalPnL) }}</td>
                                <td class="p-5 text-right font-bold text-base" :class="item.roi >= 0 ? 'text-up' : 'text-down'">{{ item.roi }}%</td>
                                <td class="p-5 text-center text-slate-300 group-hover:text-blue-500"><i class="fa-solid fa-angle-right"></i></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        <div v-if="showRealizedDetail" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[90] flex items-end md:items-center justify-center p-0 md:p-6 transition-all duration-300">
            <div class="bg-white w-full md:max-w-4xl h-[90vh] md:h-auto md:max-h-[85vh] rounded-t-[2rem] md:rounded-[2rem] shadow-2xl flex flex-col overflow-hidden animate-slide-up md:animate-none">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div>
                        <h3 class="text-xl font-black text-slate-800 flex items-center gap-2">
                             <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded-lg">{{ realizedDetailCode }}</span>
                             交易明細紀錄
                        </h3>
                        <p class="text-xs text-slate-500 font-bold mt-1">顯示該股所有歷史買賣紀錄</p>
                    </div>
                    <button @click="closeRealizedDetail" class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center transition"><i class="fa-solid fa-xmark text-lg"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-0 md:p-6 bg-slate-50">
                    <div class="md:hidden">
                        <div v-for="tx in realizedDetailTransactions" :key="tx.id" class="bg-white p-4 border-b border-slate-100 last:border-0">
                             <div class="flex justify-between items-center mb-2">
                                 <div class="text-xs font-bold text-slate-400">{{ tx.date }}</div>
                                 <span class="px-2 py-0.5 rounded text-[10px] font-black" :class="tx.type === 'buy' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'">{{ txTypeLabel(tx) }}</span>
                             </div>
                             <div class="flex justify-between items-center">
                                 <div class="font-bold text-slate-700 text-sm">{{ tx.price }} x {{ formatCurrency(tx.qty) }}</div>
                                 <div class="text-right">
                                     <div class="font-black text-sm text-slate-800">{{ formatCurrency(tx.totalAmount) }}</div>
                                     <div v-if="tx.type === 'sell'" class="text-xs font-bold" :class="tx.realizedPnL >= 0 ? 'text-up' : 'text-down'">損益: {{ tx.realizedPnL > 0 ? '+' : '' }}{{ formatCurrency(tx.realizedPnL) }}</div>
                                 </div>
                             </div>
                        </div>
                    </div>

                    <div class="hidden md:block bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-500"><tr class="border-b border-slate-200"><th class="px-6 py-3 font-bold">日期</th><th class="px-6 py-3 font-bold">交易類別</th><th class="px-6 py-3 text-right font-bold">成交價</th><th class="px-6 py-3 text-right font-bold">股數</th><th class="px-6 py-3 text-right font-bold">費用(含稅)</th><th class="px-6 py-3 text-right font-bold">總金額</th><th class="px-6 py-3 text-right font-bold">損益</th></tr></thead>
                            <tbody class="divide-y divide-slate-100">
                                <tr v-for="tx in realizedDetailTransactions" :key="tx.id" class="hover:bg-slate-50">
                                    <td class="px-6 py-3 font-bold text-slate-600">{{ tx.date }}</td>
                                    <td class="px-6 py-3"><span class="px-2 py-1 rounded text-xs font-bold" :class="tx.type === 'buy' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'">{{ txTypeLabel(tx) }}</span></td>
                                    <td class="px-6 py-3 text-right font-bold text-slate-700">{{ tx.price }}</td>
                                    <td class="px-6 py-3 text-right font-bold text-slate-700">{{ formatCurrency(tx.qty) }}</td>
                                    <td class="px-6 py-3 text-right text-xs text-slate-400">{{ formatCurrency(tx.fee + (tx.tax || 0)) }}</td>
                                    <td class="px-6 py-3 text-right font-bold text-slate-800">{{ formatCurrency(tx.totalAmount) }}</td>
                                    <td class="px-6 py-3 text-right font-black"><span v-if="tx.realizedPnL !== null" :class="tx.realizedPnL >= 0 ? 'text-up' : 'text-down'">{{ tx.realizedPnL > 0 ? '+' : '' }}{{ formatCurrency(tx.realizedPnL) }}</span><span v-else class="text-slate-300">-</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="contextMenu.visible" class="context-menu" ref="contextMenuEl" :style="{ top: contextMenu.y + 'px', left: contextMenu.x + 'px' }">
            <div class="px-4 py-2 bg-slate-100 text-xs font-bold text-slate-500 border-b border-slate-200">設定狀態: {{ contextMenu.stock?.name }}</div>
            <div @click="setManualStatus(0, false)" class="context-item"><i class="fa-solid fa-circle-check text-green-500 w-5"></i> 恢復正常</div>
            <div @click="setManualStatus(0, true)" class="context-item"><i class="fa-solid fa-triangle-exclamation text-red-500 w-5"></i> 設為注意股</div>
            <div @click="setManualStatus(5, false)" class="context-item"> 處置 (5分)</div>
            <div @click="setManualStatus(20, false)" class="context-item"> 處置 (20分)</div>
        </div>

        <div v-if="showSellModal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex justify-center items-center z-50 p-4 transition-all duration-300">
            <div class="bg-white rounded-[2rem] p-8 w-full max-w-md shadow-2xl relative border-2 border-white">
                <button @click="showSellModal = false" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 transition"><i class="fa-solid fa-times text-xl"></i></button>
                <h3 class="text-2xl font-extrabold text-slate-800 mb-6 flex items-center"><i class="fa-solid fa-sack-dollar text-green-500 mr-3 text-3xl"></i> 股票賣出</h3>
                <div class="bg-slate-50 p-5 rounded-2xl mb-6 border border-slate-200 flex justify-between items-center shadow-inner">
                    <div><div class="font-black text-xl text-slate-800">{{ sellTx.name }}</div><div class="text-sm text-blue-600 font-bold">{{ sellTx.code }}</div></div>
                    <div class="text-right"><div class="text-xs text-slate-400 font-bold uppercase mb-1">庫存股數</div><div class="font-black text-2xl text-slate-800">{{ formatCurrency(sellTx.maxQty) }}</div></div>
                </div>
                <div class="space-y-6">
                    <div class="input-group"><label class="text-xs font-bold text-slate-500 mb-2 ml-1">交易日期</label><div class="relative flex items-center"><input type="date" v-model="sellTx.date" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm"><i class="fa-regular fa-calendar-days absolute left-4 text-slate-400 text-lg pointer-events-none"></i></div></div>
                    <div class="input-group"><label class="text-xs font-bold text-slate-500 mb-2 ml-1">賣出價格</label><div class="relative flex items-center"><input type="number" step="0.01" v-model.number="sellTx.price" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm text-green-600"><i class="fa-solid fa-dollar-sign absolute left-4 text-slate-400 text-base pointer-events-none"></i></div></div>
                    <div class="input-group"><label class="text-xs font-bold text-slate-500 mb-2 ml-1">賣出股數</label><div class="relative flex items-center"><input type="number" v-model.number="sellTx.qty" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm" :max="sellTx.maxQty"><i class="fa-solid fa-cubes absolute left-4 text-slate-400 text-base pointer-events-none"></i></div><div class="flex justify-end mt-2"><button @click="sellTx.qty = sellTx.maxQty" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded font-bold hover:bg-blue-100">全部賣出</button></div>
                    <div class="flex items-center justify-between bg-amber-50 border border-amber-200 rounded-xl px-4 py-3">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-bolt text-amber-500 text-lg"></i>
                            <div>
                                <div class="font-black text-slate-800">當沖賣出</div>
                                <div class="text-xs text-slate-500 font-bold">使用當沖證交稅率 {{ settings.dayTradeTaxRate }}%</div>
                            </div>
                        </div>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" v-model="sellTx.isDayTrade" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:bg-amber-500 relative after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border after:border-slate-200 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-5"></div>
                        </label>
                    </div>
</div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button @click="showSellModal = false" class="h-[54px] w-1/3 rounded-xl font-bold text-slate-500 bg-white border-2 border-slate-200 hover:bg-slate-50 hover:border-slate-400 transition-all duration-200 active:scale-95">取消</button>
                    <button @click="confirmSell" class="h-[54px] w-2/3 rounded-xl font-bold text-white bg-gradient-to-r from-emerald-400 to-teal-600 shadow-xl shadow-emerald-300 hover:shadow-2xl hover:shadow-emerald-400 hover:-translate-y-1 transition-all duration-300 active:scale-95 flex items-center justify-center">確認賣出 <i class="fa-solid fa-check ml-2"></i></button>
                </div>
            </div>
        </div>

        <div v-if="showEditBuyModal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex justify-center items-center z-50 p-4 transition-all duration-300">
          <div class="bg-white rounded-[2rem] p-8 w-full max-w-md shadow-2xl relative border-2 border-white">
            <button @click="closeEditBuyModal" class="absolute top-5 right-5 w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-500 flex items-center justify-center transition"><i class="fa-solid fa-xmark text-lg"></i></button>
            <h3 class="text-2xl font-black text-slate-800 mb-2">編輯買入紀錄</h3>
            <p class="text-sm text-slate-500 font-medium mb-6">可修正日期、價格、股數與分類。儲存後系統會重新計算費用與持倉成本。</p>
            <div class="space-y-4">
              <div><label class="block text-xs font-bold text-slate-500 mb-1">日期</label><input v-model="editBuyTx.date" type="date" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-400 focus:ring-0 outline-none bg-white font-bold text-slate-700"/></div>
              <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">分類</label><select v-model="editBuyTx.category" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-400 focus:ring-0 outline-none bg-white font-bold text-slate-700"><option value="core">主力</option><option value="rotation">輪動</option></select></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">股票代號</label><input v-model="editBuyTx.code" type="text" disabled class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 bg-slate-50 font-bold text-slate-500"/></div>
              </div>
              <div><label class="block text-xs font-bold text-slate-500 mb-1">股票名稱</label><input v-model="editBuyTx.name" type="text" disabled class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 bg-slate-50 font-bold text-slate-500"/></div>
              <div class="grid grid-cols-2 gap-3">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">買入價格</label><input v-model.number="editBuyTx.price" type="number" step="0.01" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-400 focus:ring-0 outline-none bg-white font-bold text-slate-700"/></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">買入股數</label><input v-model.number="editBuyTx.qty" type="number" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-400 focus:ring-0 outline-none bg-white font-bold text-slate-700"/></div>
              </div>
              <div class="flex gap-3 pt-2">
                <button @click="closeEditBuyModal" class="h-[54px] w-1/3 rounded-xl font-bold text-slate-500 bg-white border-2 border-slate-200 hover:bg-slate-50 hover:border-slate-400 transition-all duration-200 active:scale-95">取消</button>
                <button @click="saveEditedBuy" class="h-[54px] w-2/3 rounded-xl font-bold text-white bg-gradient-to-r from-blue-600 to-indigo-700 shadow-xl shadow-blue-300 hover:shadow-2xl hover:shadow-blue-400 hover:-translate-y-1 transition-all duration-300 active:scale-95 flex items-center justify-center">儲存修改 <i class="fa-solid fa-check ml-2"></i></button>
              </div>
            </div>
          </div>
        </div>

        <div v-if="showEditTxModal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex justify-center items-center z-50 p-4 transition-all duration-300">
            <div class="bg-white rounded-[2rem] p-8 w-full max-w-md shadow-2xl relative border-2 border-white">
                <button @click="closeEditTxModal" class="absolute top-5 right-5 w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-500 flex items-center justify-center transition"><i class="fa-solid fa-xmark text-lg"></i></button>
                <h3 class="text-2xl font-black text-slate-800 mb-2">編輯交易紀錄</h3>
                <p class="text-sm text-slate-500 font-medium mb-6">可修正日期、股名/代號、價格、股數與分類。儲存後系統會重新計算費用與賣出損益。</p>
                <div class="space-y-4">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">日期</label><input v-model="editTx.date" type="date" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-400 focus:ring-0 outline-none bg-white font-bold text-slate-700"/></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">買賣</label><select v-model="editTx.type" disabled class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 bg-slate-50 font-bold text-slate-500"><option value="buy">買入</option><option value="sell">賣出</option></select></div>
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">分類</label><select v-model="editTx.category" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-400 focus:ring-0 outline-none bg-white font-bold text-slate-700"><option value="core">主力</option><option value="rotation">輪動</option></select></div>
                    </div>
                    <div v-if="editTx.type === 'sell'" class="flex items-center justify-between bg-amber-50 border border-amber-200 rounded-xl px-4 py-3">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-bolt text-amber-500"></i>
                            <div>
                                <div class="font-black text-slate-800">當沖賣出</div>
                                <div class="text-xs text-slate-500 font-bold">使用當沖證交稅率 {{ settings.dayTradeTaxRate }}%</div>
                            </div>
                        </div>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" v-model="editTx.isDayTrade" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:bg-amber-500 relative after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border after:border-slate-200 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-5"></div>
                        </label>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">股票代號</label><input v-model="editTx.code" type="text" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-400 focus:ring-0 outline-none bg-white font-bold text-slate-700"/></div>
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">股票名稱</label><input v-model="editTx.name" type="text" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-400 focus:ring-0 outline-none bg-white font-bold text-slate-700"/></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">價格</label><input v-model.number="editTx.price" type="number" step="0.01" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-400 focus:ring-0 outline-none bg-white font-bold text-slate-700"/></div>
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">股數</label><input v-model.number="editTx.qty" type="number" step="1" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-400 focus:ring-0 outline-none bg-white font-bold text-slate-700"/></div>
                    </div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button type="button" @click="closeEditTxModal" class="flex-1 px-5 py-3 rounded-xl font-black bg-white border-2 border-slate-200 text-slate-600 hover:bg-slate-50 hover:border-slate-400 transition">取消</button>
                    <button type="button" @click="saveEditedTxFromHistory" class="flex-1 px-5 py-3 rounded-xl font-black bg-blue-600 text-white hover:bg-blue-700 shadow-lg hover:shadow-blue-400 transition">儲存修改</button>
                </div>
            </div>
        </div>

        <div v-if="showConfirmModal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex justify-center items-center z-[100] p-6 transition-all duration-300"><div class="bg-white rounded-[2rem] p-8 w-full max-w-sm shadow-2xl transform scale-100 flex flex-col items-center text-center relative border-2 border-red-50"><div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center text-red-500 text-4xl mb-5 shadow-inner"><i class="fa-solid fa-triangle-exclamation"></i></div><h3 class="text-2xl font-black text-slate-800 mb-3">{{ confirmTitle }}</h3><p class="text-slate-500 font-bold mb-8 leading-relaxed">{{ confirmMessage }}</p><div class="flex gap-4 w-full"><button @click="showConfirmModal = false" class="h-[54px] flex-1 rounded-xl font-bold text-slate-500 bg-white border-2 border-slate-200 hover:bg-slate-50 hover:border-slate-400 transition-all duration-200 active:scale-95">取消</button><button @click="confirmAction" class="h-[54px] flex-1 rounded-xl font-bold text-white bg-gradient-to-r from-rose-500 to-red-600 shadow-xl shadow-rose-300 hover:shadow-2xl hover:shadow-rose-400 hover:-translate-y-1 transition-all duration-300 active:scale-95">確認執行</button></div></div></div>
        <div v-if="showInfoModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex justify-center items-center z-[100] p-6 transition-all duration-300"><div class="bg-white rounded-[2rem] p-8 w-full max-w-sm shadow-2xl transform scale-100 flex flex-col items-center text-center"><div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-3xl mb-4 shadow-sm"><i class="fa-solid fa-circle-info"></i></div><h3 class="text-xl font-black text-slate-800 mb-2">{{ infoTitle }}</h3><p class="text-slate-500 font-bold mb-6">{{ infoMessage }}</p><button @click="showInfoModal = false" class="h-[54px] w-full rounded-xl font-bold text-white bg-gradient-to-r from-blue-500 to-indigo-600 shadow-xl shadow-blue-300 hover:shadow-2xl hover:shadow-blue-400 hover:-translate-y-1 transition-all duration-300 active:scale-95">好，我知道了</button></div></div>
        
        <div v-if="showGDriveModal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex justify-center items-center z-[85] p-4">
            <div class="bg-white w-full max-w-xl rounded-3xl shadow-2xl shadow-slate-900/20 overflow-hidden relative flex flex-col max-h-[calc(100dvh-2rem)]">
                <div class="p-6 md:p-8 border-b border-slate-100 shrink-0 sticky top-0 bg-white z-10"><div class="flex items-start justify-between gap-4"><div class="flex items-center gap-3"><div class="w-12 h-12 rounded-2xl bg-blue-50 flex items-center justify-center text-blue-600"><i class="fa-solid fa-cloud text-xl"></i></div><div><div class="text-xl font-extrabold text-slate-900">Google 雲端備份</div><div class="text-sm text-slate-500 mt-1">將資料備份到 Google Drive（AppDataFolder）或從雲端回復。</div></div></div><button @click="showGDriveModal = false" class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200 active:scale-95"><i class="fa-solid fa-xmark"></i></button></div></div>
                <div class="flex-1 overflow-y-auto"><div class="p-4 md:p-8 space-y-6 pb-32"><div class="rounded-2xl border border-slate-200 bg-slate-50 p-4"><div class="text-sm font-bold text-slate-700 mb-2">Google OAuth Client ID（Web）</div><input v-model="gdriveClientIdInput" type="text" placeholder="Client ID..." class="w-full h-12 px-4 rounded-xl bg-white border border-slate-200 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-400" /><div class="flex flex-wrap gap-3 mt-3"><button @click="saveGDriveClientId" :disabled="gdriveBusy" class="h-11 px-4 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 active:scale-[0.98] disabled:opacity-60 disabled:cursor-not-allowed">儲存 Client ID</button><button @click="clearGDriveClientId" :disabled="gdriveBusy" class="h-11 px-4 rounded-xl font-bold bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 active:scale-[0.98] disabled:opacity-60 disabled:cursor-not-allowed">清除</button><div class="text-xs text-slate-500 flex items-center">目前：<span class="ml-1 font-mono text-slate-600">{{ gdriveClientId ? '已設定' : '未設定' }}</span></div></div></div><div class="rounded-2xl border border-slate-200 bg-white p-4"><div class="flex items-center justify-between gap-3"><div class="text-sm font-extrabold text-slate-700">備份狀態</div><button @click="refreshGDriveCloudMeta" :disabled="gdriveBusy" class="h-9 px-3 rounded-xl text-xs font-extrabold bg-slate-50 border border-slate-200 text-slate-700 hover:bg-slate-100 active:scale-[0.98] disabled:opacity-60 disabled:cursor-not-allowed flex items-center gap-2"><i class="fa-solid fa-rotate"></i> 刷新雲端狀態</button></div><div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-xs"><div class="rounded-xl bg-slate-50 border border-slate-200 p-3"><div class="font-bold text-slate-500">雲端檔案最後修改</div><div class="mt-1 font-extrabold text-slate-800">{{ formatDateTime(gdriveCloudMeta.cloudFileModifiedTime) }}</div></div><div class="rounded-xl bg-slate-50 border border-slate-200 p-3"><div class="font-bold text-slate-500">最後操作來源</div><div class="mt-1 font-extrabold text-slate-800">{{ gdriveLastActionLabel }}</div></div><div class="rounded-xl bg-slate-50 border border-slate-200 p-3"><div class="font-bold text-slate-500">最後雲端上傳</div><div class="mt-1 font-extrabold text-slate-800">{{ formatDateTime(gdriveCloudMeta.lastCloudUploadAt) }}</div></div><div class="rounded-xl bg-slate-50 border border-slate-200 p-3"><div class="font-bold text-slate-500">最後雲端回復</div><div class="mt-1 font-extrabold text-slate-800">{{ formatDateTime(gdriveCloudMeta.lastCloudRestoreAt) }}</div></div></div></div></div></div>
                <div class="sticky bottom-0 z-20 bg-white/95 backdrop-blur border-t border-slate-100 shrink-0"><div class="p-4 md:px-8 md:py-6 space-y-3"><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><button @click="uploadToGDrive" :disabled="gdriveBusy" class="h-14 rounded-2xl font-extrabold text-white bg-emerald-500 shadow-lg shadow-emerald-500/25 hover:bg-emerald-600 active:scale-[0.98] disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center gap-2"><i class="fa-solid fa-cloud-arrow-up"></i> 上傳資料到雲端</button><button @click="restoreFromGDrive" :disabled="gdriveBusy" class="h-14 rounded-2xl font-extrabold text-white bg-indigo-500 shadow-lg shadow-indigo-500/25 hover:bg-indigo-600 active:scale-[0.98] disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center gap-2"><i class="fa-solid fa-cloud-arrow-down"></i> 從雲端回復資料</button></div><button @click="showGDriveModal = false" :disabled="gdriveBusy" class="w-full h-12 rounded-2xl font-bold bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 active:scale-[0.98] disabled:opacity-60 disabled:cursor-not-allowed">關閉</button></div></div>
                <div v-if="gdriveBusy" class="absolute inset-0 bg-white/75 backdrop-blur-sm flex items-center justify-center"><div class="flex items-center gap-3 bg-white rounded-2xl px-5 py-4 shadow-lg border border-slate-200"><i class="fa-solid fa-spinner fa-spin text-slate-600"></i><div class="text-sm font-bold text-slate-700">{{ gdriveBusyText || '處理中…' }}</div></div></div>
            </div>
        </div>

        <div v-if="showHelpModal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex justify-center items-center z-[80] p-4 transition-all duration-300">
             <div class="bg-white w-full max-w-2xl rounded-[2rem] shadow-2xl relative flex flex-col max-h-[90vh]">
                <div class="flex justify-between items-center p-6 border-b border-slate-100"><h3 class="text-2xl font-extrabold text-slate-800 flex items-center"><i class="fa-solid fa-book-open text-blue-500 mr-3"></i> 系統使用說明</h3><button @click="showHelpModal = false" class="w-9 h-9 rounded-full bg-slate-50 text-slate-400 border border-slate-200 flex items-center justify-center hover:bg-slate-100 transition"><i class="fa-solid fa-times"></i></button></div>
                <div class="overflow-y-auto p-6 space-y-8">
                    <div>
                        <h4 class="text-lg font-black text-slate-700 mb-3 flex items-center">快速入門</h4>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-slate-600 space-y-3 leading-relaxed">
                            <p><strong>1) 先設定費率：</strong>右上角 <i class="fa-solid fa-gear mx-1"></i>「費率設定」填入你的券商手續費、折扣、最低手續費、證交稅；若有當沖，請設定「當沖證交稅率」。</p>
                            <p><strong>2) 建立交易：</strong>在「庫存」頁新增買入；從持倉卡片點「賣出」完成結算，或使用「融券賣出 / 回補」記錄做空。</p>
                            <p><strong>3) 更新股價：</strong>按「更新股價」抓取 Yahoo 最新價格，計算未實現損益。</p>
                            <p><strong>4) 備份：</strong>右上角 <i class="fa-solid fa-download mx-1"></i> 下載備份檔，或用 <i class="fa-solid fa-cloud mx-1"></i> Google 雲端備份（需先填 OAuth Client ID）。</p>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-black text-slate-700 mb-3">交易類型與計算規則</h4>
                        <div class="bg-white p-4 rounded-xl border border-slate-200 text-sm text-slate-600 space-y-3 leading-relaxed">
                            <div class="grid sm:grid-cols-2 gap-3">
                                <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                                    <div class="font-extrabold text-slate-700 mb-1">買入（做多）</div>
                                    <div>建立/加碼多單。<br>成本 = 價格×股數 + 手續費</div>
                                </div>
                                <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                                    <div class="font-extrabold text-slate-700 mb-1">賣出（平多/減碼）</div>
                                    <div>減碼或出清多單。<br>入帳 = 價格×股數 − 手續費 − 證交稅</div>
                                </div>
                                <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                                    <div class="font-extrabold text-slate-700 mb-1">融券賣出（做空）</div>
                                    <div>先賣出建立空單，允許在沒有庫存時賣出。<br>空單持倉會顯示「股數為負」。</div>
                                </div>
                                <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                                    <div class="font-extrabold text-slate-700 mb-1">回補（平空）</div>
                                    <div>買回減少/結束空單。<br>若回補股數超過空單，超出部分會轉為多單。</div>
                                </div>
                            </div>
                            <div class="pt-2">
                                <div class="font-extrabold text-slate-700 mb-1">損益算法</div>
                                <ul class="list-disc pl-5 space-y-1">
                                    <li>系統採<strong>平均成本法</strong>（同一股票以加權平均成本計算已實現損益）。</li>
                                    <li><strong>已實現損益</strong>：每筆平倉（賣出平多 / 回補平空）當下就計入。</li>
                                    <li><strong>未實現損益</strong>：以最新股價估算，多單/空單都會計算（空單價格下跌為正）。</li>
                                    <li>手續費依「費率 × 折扣」計算並套用最低手續費；證交稅僅在「賣出」端計入（含融券賣出）。</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-black text-slate-700 mb-3">新增交易：做多 / 做空 / 當沖</h4>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-slate-600 space-y-4 leading-relaxed">
                            <div>
                                <div class="font-extrabold text-slate-700 mb-1">A. 新增買入（做多）</div>
                                <ul class="list-disc pl-5 space-y-1">
                                    <li>在「庫存」頁輸入<strong>代碼、成交價、股數</strong>，可選擇核心/衛星分類。</li>
                                    <li>新增後會立刻更新持倉成本與平均成本。</li>
                                </ul>
                            </div>
                            <div>
                                <div class="font-extrabold text-slate-700 mb-1">B. 賣出（平多/減碼）</div>
                                <ul class="list-disc pl-5 space-y-1">
                                    <li>在持倉卡片點「賣出」，輸入賣出價格與股數。</li>
                                    <li>若為當沖，請勾選<strong>「當沖」</strong>（見下段）。</li>
                                </ul>
                            </div>
                            <div>
                                <div class="font-extrabold text-slate-700 mb-1">C. 融券賣出（做空）</div>
                                <ul class="list-disc pl-5 space-y-1">
                                    <li>選擇「融券賣出 / 做空」並輸入賣出價格、股數。</li>
                                    <li>建立後該股票持倉股數會變成<strong>負值</strong>，代表空單。</li>
                                    <li>若屬當沖放空（先賣後買），賣出那筆也可勾「當沖」。</li>
                                </ul>
                            </div>
                            <div>
                                <div class="font-extrabold text-slate-700 mb-1">D. 回補（平空）</div>
                                <ul class="list-disc pl-5 space-y-1">
                                    <li>當持倉為負時，新增「回補 / 買回」並輸入買回價格、股數。</li>
                                    <li>回補會逐筆結算空單的已實現損益（空單：賣得高、買得低為正）。</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-black text-slate-700 mb-3">當沖（Day Trade）設定與記帳方式</h4>
                        <div class="bg-white p-4 rounded-xl border border-slate-200 text-sm text-slate-600 space-y-3 leading-relaxed">
                            <p><strong>目的：</strong>當沖在台股通常適用不同的證交稅率。系統用「每筆賣出是否為當沖」來決定使用哪個稅率。</p>
                            <ul class="list-disc pl-5 space-y-1">
                                <li>到「費率設定」填入<strong>當沖證交稅率 (%)</strong>（預設 0.15）。</li>
                                <li>在新增/編輯「賣出」時勾選<strong>當沖</strong>，該筆賣出會改用當沖稅率計算證交稅。</li>
                                <li>同樣適用於<strong>融券賣出</strong>（當沖放空：先賣後買）。</li>
                                <li>若你沒有做當沖，保持不勾選即可（會使用一般證交稅率）。</li>
                            </ul>
                            <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                                <div class="font-extrabold text-slate-700 mb-1">小提醒</div>
                                <div>系統不會自動判斷「是否同日沖銷」；是否為當沖由你在賣出時勾選，以符合你的實際成交與券商稅率。</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-black text-slate-700 mb-3">更新股價、警示/處置狀態</h4>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-slate-600 space-y-3 leading-relaxed">
                            <ul class="list-disc pl-5 space-y-1">
                                <li><strong>更新股價：</strong>按下後會透過 Yahoo Finance 抓最新價格，並寫入快取；若抓不到，會沿用上次成功的價格。</li>
                                <li><strong>處置/注意：</strong>系統會嘗試從 Yahoo 頁面判斷是否為處置/注意標的，並顯示於持倉卡片（此功能可能受 Yahoo 版面調整影響）。</li>
                                <li><strong>全球指數（夜）：</strong>提供美股與夜盤參考（資料來源依網路狀況可能延遲）。</li>
                            </ul>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-black text-slate-700 mb-3">歷史帳務：列表與分析</h4>
                        <div class="bg-white p-4 rounded-xl border border-slate-200 text-sm text-slate-600 space-y-3 leading-relaxed">
                            <ul class="list-disc pl-5 space-y-1">
                                <li><strong>列表：</strong>可依日期、類型（買/賣/融券/回補）篩選，並支援刪除、編輯交易。</li>
                                <li><strong>分析：</strong>依股票彙總已實現損益、報酬率、交易筆數等，便於回顧策略表現。</li>
                                <li><strong>重算：</strong>每次新增/編輯/刪除交易後，系統會依時間順序重新計算持倉與損益，確保一致性。</li>
                            </ul>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-black text-slate-700 mb-3">備份、還原與資料安全</h4>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-slate-600 space-y-3 leading-relaxed">
                            <ul class="list-disc pl-5 space-y-1">
                                <li><strong>本機資料：</strong>所有資料預設存於你目前瀏覽器的 localStorage。清除瀏覽器資料/更換裝置會造成資料消失，請定期備份。</li>
                                <li><strong>下載備份：</strong>會匯出一個 JSON 檔；「匯入還原」會以備份檔覆蓋目前資料。</li>
                                <li><strong>Google 雲端備份：</strong>備份檔會存到你的 Google Drive <code>appDataFolder</code>（一般檔案列表看不到），需先在雲端備份設定填入 OAuth Client ID 才能使用。</li>
                                <li><strong>安全性設定：</strong>本系統的登入保護主要是避免他人誤操作；仍建議搭配 OS/瀏覽器帳號安全、不要在公用電腦使用。</li>
                            </ul>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-black text-slate-700 mb-3">常見問題</h4>
                        <div class="bg-white p-4 rounded-xl border border-slate-200 text-sm text-slate-600 space-y-3 leading-relaxed">
                            <div>
                                <div class="font-extrabold text-slate-700 mb-1">Q1：股價更新失敗？</div>
                                <div>A：可能是網路或資料來源暫時異常。你仍可繼續記帳；未實現損益會使用上次成功抓到的價格。稍後再按一次更新即可。</div>
                            </div>
                            <div>
                                <div class="font-extrabold text-slate-700 mb-1">Q2：為什麼持倉股數會是負的？</div>
                                <div>A：代表你有空單（融券賣出）。用「回補」買回後，股數會回到 0；若回補超過空單，會轉成多單。</div>
                            </div>
                            <div>
                                <div class="font-extrabold text-slate-700 mb-1">Q3：當沖一定要勾嗎？</div>
                                <div>A：只有在該筆賣出屬於當沖、且你的券商適用當沖稅率時才勾。系統以勾選與否決定該筆賣出使用的證交稅率。</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t border-slate-100"><button @click="showHelpModal = false" class="w-full h-[50px] bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition-transform">了解，開始使用</button></div>
             </div>
        </div>

        <div v-if="showSettings" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex justify-center items-center z-50 p-4">
            <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm shadow-2xl relative max-h-[calc(100vh-2rem)] overflow-y-auto">
                <button @click="showSettings = false" class="absolute top-6 right-6 w-9 h-9 rounded-full bg-slate-50 text-slate-400 border border-slate-200 flex items-center justify-center active:bg-slate-200 transition-colors"><i class="fa-solid fa-times"></i></button>
                <h3 class="text-xl font-extrabold mb-8 text-slate-800 flex items-center tracking-tight">費率設定</h3>
                
                <div class="space-y-5">
                    <!-- Mobile-first layout: 折扣整行，其餘欄位半行（兩欄一列） -->
                    <div class="input-group">
                        <div class="flex justify-between items-center mb-2 ml-1">
                            <label class="text-xs font-bold text-slate-500">手續費折扣</label>
                        </div>
                        <div class="flex gap-2 mb-3 overflow-x-auto pb-1 scrollbar-hide">
                            <span @click="settings.discount = 0.28" class="px-3 py-1.5 bg-slate-50 text-slate-600 rounded-lg text-xs font-bold border border-slate-200 cursor-pointer active:scale-95 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition-all whitespace-nowrap" :class="settings.discount === 0.28 ? 'bg-blue-50 text-blue-600 border-blue-400 ring-2 ring-blue-100' : ''">2.8折</span>
                            <span @click="settings.discount = 0.3" class="px-3 py-1.5 bg-slate-50 text-slate-600 rounded-lg text-xs font-bold border border-slate-200 cursor-pointer active:scale-95 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition-all whitespace-nowrap" :class="settings.discount === 0.3 ? 'bg-blue-50 text-blue-600 border-blue-400 ring-2 ring-blue-100' : ''">3折</span>
                            <span @click="settings.discount = 0.5" class="px-3 py-1.5 bg-slate-50 text-slate-600 rounded-lg text-xs font-bold border border-slate-200 cursor-pointer active:scale-95 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition-all whitespace-nowrap" :class="settings.discount === 0.5 ? 'bg-blue-50 text-blue-600 border-blue-400 ring-2 ring-blue-100' : ''">5折</span>
                            <span @click="settings.discount = 0.6" class="px-3 py-1.5 bg-slate-50 text-slate-600 rounded-lg text-xs font-bold border border-slate-200 cursor-pointer active:scale-95 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition-all whitespace-nowrap" :class="settings.discount === 0.6 ? 'bg-blue-50 text-blue-600 border-blue-400 ring-2 ring-blue-100' : ''">6折</span>
                        </div>
                        <div class="relative flex items-center">
                            <input type="number" step="0.01" v-model.number="settings.discount" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm">
                            <i class="fa-solid fa-tag absolute left-4 text-slate-400 text-lg pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <label class="text-xs font-bold text-slate-500 mb-2 ml-1">手續費率 (%)</label>
                            <div class="relative flex items-center">
                                <input type="number" v-model.number="settings.feeRate" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm">
                                <i class="fa-solid fa-percent absolute left-4 text-slate-400 text-lg pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="input-group">
                            <label class="text-xs font-bold text-slate-500 mb-2 ml-1">最低手續費 (元)</label>
                            <div class="relative flex items-center">
                                <input type="number" v-model.number="settings.minFee" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm">
                                <i class="fa-solid fa-coins absolute left-4 text-slate-400 text-lg pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="input-group">
                            <label class="text-xs font-bold text-slate-500 mb-2 ml-1">證交稅率 (%)</label>
                            <div class="relative flex items-center">
                                <input type="number" v-model.number="settings.taxRate" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm">
                                <i class="fa-solid fa-building-columns absolute left-4 text-slate-400 text-base pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="input-group">
                            <label class="text-xs font-bold text-slate-500 mb-2 ml-1">當沖證交稅率 (%)</label>
                            <div class="relative flex items-center">
                                <input type="number" v-model.number="settings.dayTradeTaxRate" class="w-full h-[50px] pl-11 pr-4 bg-white border border-slate-300 rounded-xl text-slate-700 font-bold text-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50/50 transition-all shadow-sm">
                                <i class="fa-solid fa-bolt absolute left-4 text-slate-400 text-base pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end mt-8"><button @click="saveSettings" class="w-full py-4 rounded-2xl font-bold text-white bg-blue-600 shadow-lg shadow-blue-500/30 active:scale-[0.98] transition-all text-lg flex items-center justify-center gap-2 hover:bg-blue-700">儲存設定</button></div>
            </div>
        </div>

        <div v-if="showSecurityModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex justify-center items-center z-50 p-4">
            <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm shadow-2xl relative">
                <button @click="showSecurityModal = false" class="absolute top-6 right-6 w-9 h-9 rounded-full bg-slate-50 text-slate-400 border border-slate-200 flex items-center justify-center active:bg-slate-200 transition-colors"><i class="fa-solid fa-times"></i></button>
                <h3 class="text-xl font-extrabold mb-8 text-slate-800 flex items-center tracking-tight">安全性設定</h3>
                <div class="space-y-4">
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 flex justify-between items-center">
                        <div><div class="font-bold text-slate-700">啟用登入保護</div><div class="text-xs text-slate-400 font-bold mt-1">開啟時，進入網頁需輸入密碼</div></div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="toggle" id="toggle-protection" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-200" :class="securityConfig.enabled ? 'right-0 border-blue-500' : 'left-0 border-slate-300'" v-model="securityConfig.enabled" @change="updateSecurityConfig"/><label for="toggle-protection" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer" :class="securityConfig.enabled ? 'bg-blue-500' : 'bg-slate-300'"></label></div>
                    </div>
                    <button @click="showChangePasswordModal = true; showSecurityModal = false" class="w-full p-4 bg-white border border-slate-200 rounded-xl text-slate-700 font-bold flex items-center justify-between hover:bg-slate-50 active:scale-98 transition"><span class="flex items-center gap-3"><i class="fa-solid fa-key text-slate-400"></i> 變更密碼</span><i class="fa-solid fa-chevron-right text-slate-300 text-sm"></i></button>
                    <button @click="logout" class="w-full p-4 bg-white border border-slate-200 rounded-xl text-slate-700 font-bold flex items-center justify-between hover:bg-slate-50 active:scale-98 transition"><span class="flex items-center gap-3"><i class="fa-solid fa-arrow-right-from-bracket text-slate-400"></i> 登出並鎖定</span><i class="fa-solid fa-chevron-right text-slate-300 text-sm"></i></button>
                    <hr class="border-slate-100 my-2">
                    <button @click="triggerClearAuth" class="w-full p-4 bg-red-50 border border-red-100 rounded-xl text-red-600 font-bold flex items-center justify-center hover:bg-red-100 active:scale-98 transition"><i class="fa-solid fa-user-xmark mr-2"></i> 清除已儲存密碼</button>
                </div>
            </div>
        </div>

        <div v-if="showChangePasswordModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex justify-center items-center z-[60] p-4">
             <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm shadow-2xl relative">
                <button @click="showChangePasswordModal = false; showSecurityModal = true" class="absolute top-6 right-6 w-9 h-9 rounded-full bg-slate-50 text-slate-400 border border-slate-200 flex items-center justify-center active:bg-slate-200 transition-colors"><i class="fa-solid fa-times"></i></button>
                <h3 class="text-xl font-extrabold mb-6 text-slate-800">變更密碼</h3>
                <div class="space-y-4">
                    <div class="input-group"><label class="text-xs font-bold text-slate-500 mb-2 ml-1">舊密碼</label><input type="password" v-model="changePassInput.old" class="w-full h-[50px] px-4 bg-white border border-slate-300 rounded-xl font-bold outline-none focus:border-blue-500"></div>
                    <div class="input-group"><label class="text-xs font-bold text-slate-500 mb-2 ml-1">新密碼</label><input type="password" v-model="changePassInput.new" class="w-full h-[50px] px-4 bg-white border border-slate-300 rounded-xl font-bold outline-none focus:border-blue-500"></div>
                    <button @click="handleChangePassword" class="w-full py-4 mt-2 rounded-2xl font-bold text-white bg-blue-600 shadow-lg active:scale-[0.98]">確認變更</button>
                </div>
             </div>
        </div>

        <div v-if="showExportModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex justify-center items-center z-[70] p-4 transition-opacity">
            <div class="bg-white rounded-[1.75rem] w-full max-w-md shadow-2xl relative animate-slide-up md:animate-none max-h-[85vh] overflow-y-auto">
                <div class="p-5 md:p-7">
                    <div class="flex items-start justify-between gap-4 mb-4"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center shadow-sm"><i class="fa-solid fa-cloud-arrow-down"></i></div><div><div class="text-lg font-black text-slate-800 leading-tight">備份</div><div class="text-xs font-bold text-slate-400 mt-1">下載 JSON 備份檔，或用備份檔還原資料（會覆蓋本機資料）。</div></div></div><button @click="showExportModal=false" class="w-10 h-10 rounded-full bg-slate-50 border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-slate-100"><i class="fa-solid fa-xmark"></i></button></div>
                    <div class="grid grid-cols-2 gap-2 mb-5"><button @click="backupTab='download'" :class="backupTab==='download' ? 'bg-emerald-600 text-white shadow' : 'bg-slate-50 text-slate-600 border border-slate-200'" class="h-11 rounded-xl font-extrabold transition-all"><i class="fa-solid fa-download mr-2"></i>下載備份</button><button @click="backupTab='restore'" :class="backupTab==='restore' ? 'bg-indigo-600 text-white shadow' : 'bg-slate-50 text-slate-600 border border-slate-200'" class="h-11 rounded-xl font-extrabold transition-all"><i class="fa-solid fa-rotate-right mr-2"></i>還原備份</button></div>
                    <div v-if="backupTab==='download'"><div class="space-y-4"><div><div class="text-sm font-extrabold text-slate-700 mb-2">檔案名稱</div><div class="flex items-center gap-2"><input v-model="exportFileName" class="flex-1 h-12 rounded-xl px-4 text-slate-700 font-bold bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-300" placeholder="stock_backup_YYYY-MM-DD"><div class="text-sm font-black text-slate-400">.json</div></div><div class="text-xs font-bold text-slate-400 mt-2">包含：交易紀錄／自選股／設定參數／最新價格／狀態／更新時間</div></div><div class="flex gap-3"><button @click="showExportModal=false" class="flex-1 h-12 rounded-xl font-extrabold text-slate-600 bg-slate-50 border border-slate-200 hover:bg-slate-100 active:scale-[0.98] transition-all">取消</button><button @click="confirmExport" class="flex-1 h-12 rounded-xl font-extrabold text-white bg-emerald-600 hover:bg-emerald-700 active:scale-[0.98] transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-download"></i> 確認下載</button></div></div></div>
                    <div v-else class="space-y-4"><div class="rounded-2xl border border-amber-200 bg-amber-50 p-4"><div class="text-sm font-black text-amber-700 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> 還原會覆蓋目前本機資料</div><div class="text-xs font-bold text-amber-700/80 mt-1">建議先下載一份備份，再進行還原。</div></div><div class="rounded-2xl border border-slate-200 bg-white p-4"><div class="text-sm font-extrabold text-slate-700 mb-2">備份檔案</div><div class="flex items-center gap-2"><div class="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center text-slate-400 border border-slate-100"><i class="fa-solid fa-file-code"></i></div><div class="flex-1 min-w-0"><div class="text-xs font-bold text-slate-400 uppercase">JSON</div><div class="text-sm font-black text-slate-700 truncate">{{ restoreFileName || '尚未選擇檔案' }}</div></div></div><input ref="restoreFileInput" type="file" accept=".json,application/json" class="hidden" @change="onRestoreBackupFileChange"><div class="flex flex-col md:flex-row gap-3 mt-4"><button @click="$refs.restoreFileInput && $refs.restoreFileInput.click()" class="w-full md:flex-1 h-12 rounded-xl font-extrabold text-slate-600 bg-slate-50 border border-slate-200 hover:bg-slate-100 active:scale-[0.98] transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-folder-open"></i> 選擇檔案</button><button :disabled="!restoreFileObject || restoreBusy" @click="confirmRestoreFromBackupFile" class="w-full md:flex-1 h-12 rounded-xl font-extrabold text-white bg-indigo-600 hover:bg-indigo-700 active:scale-[0.98] disabled:opacity-60 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-rotate-right"></i> 立即還原</button></div><div v-if="restoreBusy" class="mt-3 text-xs font-bold text-slate-500 flex items-center gap-2"><i class="fa-solid fa-spinner fa-spin"></i> 正在還原備份…</div></div><div class="flex gap-3"><button @click="showExportModal=false" class="flex-1 h-12 rounded-xl font-extrabold text-slate-600 bg-slate-50 border border-slate-200 hover:bg-slate-100 active:scale-[0.98] transition-all">關閉</button><button @click="backupTab='download'" class="flex-1 h-12 rounded-xl font-extrabold text-emerald-700 bg-emerald-50 border border-emerald-200 hover:bg-emerald-100 active:scale-[0.98] transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-download"></i> 先下載備份</button></div></div>
                </div>
            </div>
        </div>

        <!-- Mobile Bottom Main Tabs -->
        <div class="md:hidden fixed bottom-0 left-0 w-full z-40 bg-white/95 backdrop-blur border-t border-slate-200 px-4 pt-2 pb-[calc(env(safe-area-inset-bottom)+10px)]">
            <div class="grid grid-cols-2 gap-2">
                <button type="button" @click="currentTab = 'inventory'; showStockDetails = false" class="flex flex-col items-center justify-center py-2 rounded-2xl font-black transition-all"
                    :class="currentTab === 'inventory' ? 'bg-blue-50 text-blue-700 border border-blue-200 shadow-sm' : 'text-slate-600 hover:bg-slate-50'">
                    <i class="fa-solid fa-briefcase text-lg"></i>
                    <span class="text-[11px] mt-1 tracking-wide">庫存管理</span>
                </button>
                <button type="button" @click="currentTab = 'history'; showStockDetails = false" class="flex flex-col items-center justify-center py-2 rounded-2xl font-black transition-all"
                    :class="currentTab === 'history' ? 'bg-indigo-50 text-indigo-700 border border-indigo-200 shadow-sm' : 'text-slate-600 hover:bg-slate-50'">
                    <i class="fa-solid fa-file-invoice-dollar text-lg"></i>
                    <span class="text-[11px] mt-1 tracking-wide">歷史帳務</span>
                </button>
            </div>
        </div>

    </div> </div>

<script>
const { createApp } = Vue;
let __gdriveTokenClient = null;
let __gdriveTokenClientCid = null;
const __GDRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.appdata';

createApp({
    data() {
        return {
            showGDriveModal: false, gdriveBusy: false, gdriveBusyText: '', gdriveCloudMeta: (() => { try { return JSON.parse(localStorage.getItem('tw_stock_cloud_meta_v1') || '{}'); } catch(e){ return {}; } })(),
            gdriveClientId: localStorage.getItem('tw_stock_gdrive_client_id_v1') || '', gdriveClientIdInput: localStorage.getItem('tw_stock_gdrive_client_id_v1') || '',
            isLoggedIn: false, authMode: 'login', authInput: { username: '', password: '', confirmPassword: '' }, rememberUser: false, authError: '', securityConfig: { enabled: true, username: '', passwordHash: '' }, showSecurityModal: false, showChangePasswordModal: false, changePassInput: { old: '', new: '' },
            currentTab: 'inventory', showStockDetails: false, selectedStock: null,
            transactions: [], newTx: { date: new Date().toISOString().split('T')[0], code: '', name: '', type: 'buy', price: null, qty: 1000, category: 'core', isDayTrade: false },
            showSellModal: false, sellTx: { date: '', code: '', name: '', price: 0, qty: 0, maxQty: 0, category: '', isDayTrade: false },
            showEditBuyModal: false, editBuyTx: { id: null, date: '', code: '', name: '', price: null, qty: 0, category: 'core' },
            showEditTxModal: false, editTx: { id: null, date: '', code: '', name: '', type: 'buy', price: null, qty: 0, category: 'core', isDayTrade: false },
            showAddModal: false, searchText: '', isSearching: false,
            settings: { feeRate: 0.1425, discount: 0.28, taxRate: 0.3, dayTradeTaxRate: 0.15, minFee: 20 },
            showSettings: false, showExportModal: false, backupTab: 'download', exportFileName: '', restoreFileName: '', restoreFileObject: null, restoreBusy: false,
            showInfoModal: false, infoTitle: '', infoMessage: '', showConfirmModal: false, confirmTitle: '', confirmMessage: '', confirmCallback: null,
            showGlobalIndices: false, isGlobalLoading: false, isTaiexNightLoading: false, globalIndices: [],
            globalIndicesLastTs: Number(localStorage.getItem('tw_stock_global_time_ts_v1')) || null,
            globalIndicesError: (localStorage.getItem('tw_stock_global_update_error_v1') === '1'), globalIndicesPartial: (localStorage.getItem('tw_stock_global_update_partial_v1') === '1'), globalIndicesMissingCount: Number(localStorage.getItem('tw_stock_global_update_missing_count_v1') || '0') || 0, globalIndicesAttemptTs: Number(localStorage.getItem('tw_stock_global_update_attempt_ts_v1')) || null,
            showHelpModal: false,
            filter: 'all', suggestions: [], showSuggestions: false, customStocks: [], 
            latestPrices: {}, latestStatus: {}, lastUpdateTime: '',
            lastUpdateTimestamp: Number(localStorage.getItem('tw_stock_time_ts_v6') || 0) || 0, lastPriceUpdateError: localStorage.getItem('tw_stock_price_update_error_v1') || '', lastPriceUpdateAttemptTs: Number(localStorage.getItem('tw_stock_price_update_attempt_ts_v1') || 0) || 0, lastPriceUpdatePartial: (localStorage.getItem('tw_stock_price_update_partial_v1') === '1'), lastPriceUpdateMissingCount: Number(localStorage.getItem('tw_stock_price_update_missing_count_v1') || 0) || 0, priceStaleThresholdMinutes: 180, isLoading: false,
            dateFilterMode: 'month', filterStart: '', filterEnd: '', historyTypeFilter: 'all',
            contextMenu: { visible: false, x: 0, y: 0, stock: null },
            rawStockData: ["2330:台積電","2317:鴻海","2454:聯發科","2603:長榮","2609:陽明","2615:萬海","0050:元大台灣50","0056:元大高股息","00878:國泰永續高股息"], baseStockMap: [],
            
            // --- NEW: History Analysis State ---
            historyMode: 'list', // 'list' | 'analysis'
            showRealizedDetail: false, realizedDetailCode: ''
        }
    },
    mounted() {
        this.gdriveClientId = localStorage.getItem('tw_stock_gdrive_client_id_v1') || ''; this.gdriveClientIdInput = this.gdriveClientId;
        this.baseStockMap = this.rawStockData.map(s => { const [code, name] = s.split(':'); return { code, name }; });
        const savedTx = localStorage.getItem('tw_stock_tx_v6'); if (savedTx) this.transactions = JSON.parse(savedTx);
        const savedSettings = localStorage.getItem('tw_stock_settings_v6'); if (savedSettings) this.settings = JSON.parse(savedSettings);
        if (this.settings == null || typeof this.settings !== 'object') this.settings = { feeRate: 0.1425, discount: 0.28, taxRate: 0.3, dayTradeTaxRate: 0.15, minFee: 20 };
        if (this.settings.dayTradeTaxRate == null || isNaN(Number(this.settings.dayTradeTaxRate))) this.settings.dayTradeTaxRate = 0.15;
        const savedCustom = localStorage.getItem('tw_stock_custom_v6'); if (savedCustom) this.customStocks = JSON.parse(savedCustom);
        const savedPrices = localStorage.getItem('tw_stock_prices_v6'); if (savedPrices) this.latestPrices = JSON.parse(savedPrices);
        const savedStatus = localStorage.getItem('tw_stock_status_v6'); if (savedStatus) this.latestStatus = JSON.parse(savedStatus);
        const savedTime = localStorage.getItem('tw_stock_time_v6'); if (savedTime) this.lastUpdateTime = savedTime;
        const savedTimeTs = localStorage.getItem('tw_stock_time_ts_v6'); if (savedTimeTs) this.lastUpdateTimestamp = Number(savedTimeTs) || 0;
        try { this.recomputeAllTradesAndValidate(); } catch (_) {}
        const savedAuth = localStorage.getItem('tw_stock_auth_v1'); const savedUser = localStorage.getItem('tw_stock_saved_username');
        if (savedUser) { this.authInput.username = savedUser; this.rememberUser = true; }
        if (savedAuth) { this.securityConfig = JSON.parse(savedAuth); if (this.securityConfig.enabled) { this.authMode = 'login'; this.isLoggedIn = false; } else { this.isLoggedIn = true; } } else { this.authMode = 'setup'; this.isLoggedIn = false; }
        window.addEventListener('click', this.handleGlobalClick, true); window.addEventListener('resize', this.closeContextMenu); window.addEventListener('scroll', this.closeContextMenu, true);
        this.setDateFilter('month');
    },
    beforeUnmount() { window.removeEventListener('click', this.handleGlobalClick, true); window.removeEventListener('resize', this.closeContextMenu); window.removeEventListener('scroll', this.closeContextMenu, true); },
    computed: {
        // --- NEW: Analysis Computed Properties ---
        realizedAnalysisList() {
            // Use existing filteredTransactions (so date filter works)
            const realized = this.filteredTransactions.filter(tx => tx.realizedPnL !== null && tx.realizedPnL !== undefined);

            const groups = {};
            realized.forEach(tx => {
                if (!groups[tx.code]) {
                    groups[tx.code] = {
                        code: tx.code,
                        name: tx.name,
                        totalClosedQty: 0,
                        totalClosedBase: 0,
                        totalPnL: 0,
                        weightedExitPriceSum: 0,
                        latestDate: tx.date
                    };
                }
                const closedQty = Number(tx.closedQty ?? tx.qty) || 0;
                const closedBase = Number(tx.closedBase ?? 0) || 0;
                groups[tx.code].totalClosedQty += closedQty;
                groups[tx.code].totalClosedBase += closedBase;
                groups[tx.code].totalPnL += Number(tx.realizedPnL) || 0;
                groups[tx.code].weightedExitPriceSum += (Number(tx.price) || 0) * closedQty;
                if (new Date(tx.date) > new Date(groups[tx.code].latestDate)) groups[tx.code].latestDate = tx.date;
            });

            return Object.values(groups).map(g => {
                const avgExitPrice = g.totalClosedQty > 0 ? g.weightedExitPriceSum / g.totalClosedQty : 0;
                const roi = g.totalClosedBase > 0 ? ((g.totalPnL / g.totalClosedBase) * 100).toFixed(2) : 0;
                return {
                    code: g.code,
                    name: g.name,
                    totalQty: g.totalClosedQty,
                    totalPnL: g.totalPnL,
                    avgPrice: avgExitPrice,
                    roi,
                    latestDate: g.latestDate
                };
            }).sort((a,b) => new Date(b.latestDate) - new Date(a.latestDate));
        },
        realizedDetailTransactions() {
            if (!this.realizedDetailCode) return [];
            // Show all history for this stock to trace P&L source
            return this.sortedTransactions.filter(tx => tx.code === this.realizedDetailCode);
        },

        // --- Existing Computed ---
        priceUpdateAgeMinutes() { if (!this.lastUpdateTimestamp) return null; const diff = Date.now() - this.lastUpdateTimestamp; return diff < 0 ? 0 : Math.floor(diff / 60000); },
        priceUpdateAgeText() { const m = this.priceUpdateAgeMinutes; if (m === null) return ''; if (m < 60) return `${m} 分鐘前`; const h = Math.floor(m / 60); const mm = m % 60; if (h < 24) return mm === 0 ? `${h} 小時前` : `${h} 小時 ${mm} 分鐘前`; const d = Math.floor(h / 24); const hh = h % 24; return hh === 0 ? `${d} 天前` : `${d} 天 ${hh} 小時前`; },
        isPriceUpdateStale() { const m = this.priceUpdateAgeMinutes; return m === null ? false : m >= (this.priceStaleThresholdMinutes || 180); },
        priceUpdateHintLevel() { if (this.lastPriceUpdateError) return 'error'; if (this.lastPriceUpdatePartial && this.lastUpdateTimestamp) return 'partial'; if (!this.lastUpdateTimestamp) return 'never'; if (this.isPriceUpdateStale) return 'stale'; return 'ok'; },
        priceUpdateHintIcon() { const lv = this.priceUpdateHintLevel; if (lv === 'error' || lv === 'partial' || lv === 'stale') return 'fa-solid fa-triangle-exclamation'; if (lv === 'ok') return 'fa-solid fa-circle-check'; return 'fa-regular fa-clock'; },
        priceUpdateHintClass() { const lv = this.priceUpdateHintLevel; if (lv === 'error' || lv === 'partial' || lv === 'stale') return 'text-amber-700'; if (lv === 'ok') return 'text-emerald-700'; return 'text-slate-500'; },
        priceUpdateHintText() { const lv = this.priceUpdateHintLevel; if (lv === 'never') return '尚未更新股價'; if (lv === 'error') return '，沿用上次價格'; if (lv === 'partial') { const miss = this.lastPriceUpdateMissingCount || 0; return miss > 0 ? `部分更新成功：${miss} 檔未更新（沿用上次價格）` : '部分更新成功（部分資料沿用上次價格）'; } if (lv === 'stale') return `價格（${this.priceUpdateAgeText}）`; if (lv === 'ok') return `價格（${this.priceUpdateAgeText}）`; return ''; },
        globalUpdateAgeMinutes() { if (!this.globalIndicesLastTs) return null; const diff = Date.now() - this.globalIndicesLastTs; return diff < 0 ? 0 : Math.floor(diff / 60000); },
        globalUpdateAgeText() { const m = this.globalUpdateAgeMinutes; if (m === null) return ''; if (m < 60) return `${m} 分鐘前`; const h = Math.floor(m / 60); const mm = m % 60; if (h < 24) return mm === 0 ? `${h} 小時前` : `${h} 小時 ${mm} 分鐘前`; const d = Math.floor(h / 24); const hh = h % 24; return hh === 0 ? `${d} 天前` : `${d} 天 ${hh} 小時前`; },
        isGlobalUpdateStale() { const m = this.globalUpdateAgeMinutes; return m === null ? false : m >= 180; },
        globalUpdateHintLevel() { if (this.globalIndicesError) return 'error'; if (this.globalIndicesPartial && this.globalIndicesLastTs) return 'partial'; if (!this.globalIndicesLastTs) return 'never'; if (this.isGlobalUpdateStale) return 'stale'; return 'ok'; },
        globalUpdateHintIcon() { const lv = this.globalUpdateHintLevel; if (lv === 'error' || lv === 'partial' || lv === 'stale') return 'fa-solid fa-triangle-exclamation'; if (lv === 'ok') return 'fa-solid fa-circle-check'; return 'fa-regular fa-clock'; },
        globalUpdateHintClass() { const lv = this.globalUpdateHintLevel; if (lv === 'error' || lv === 'partial' || lv === 'stale') return 'text-amber-700'; if (lv === 'ok') return 'text-emerald-700'; return 'text-slate-500'; },
        globalUpdateHintText() { const lv = this.globalUpdateHintLevel; if (lv === 'never') return '尚未更新全球指數（夜）'; if (lv === 'error') return '，沿用上次資料'; if (lv === 'partial') { const miss = this.globalIndicesMissingCount || 0; return miss > 0 ? `部分更新成功：${miss} 檔未更新（沿用上次資料）` : '部分更新成功（部分資料沿用上次資料）'; } if (lv === 'stale') return `指數（${this.globalUpdateAgeText}）`; if (lv === 'ok') return `指數（${this.globalUpdateAgeText}）`; return ''; },
        gdriveLastActionLabel() { const a = (this.gdriveCloudMeta && this.gdriveCloudMeta.lastAction) ? this.gdriveCloudMeta.lastAction : ''; if (a === 'upload') return '雲端上傳'; if (a === 'restore') return '雲端回復'; if (a === 'download') return '本機下載'; return '—'; },
        fullStockMap() { return [...this.baseStockMap, ...this.customStocks]; },
        sortedTransactions() { return [...this.transactions].sort((a, b) => new Date(b.date) - new Date(a.date)); },
        filteredTransactions() { if (this.dateFilterMode === 'all') return this.sortedTransactions; const start = new Date(this.filterStart).setHours(0,0,0,0); const end = new Date(this.filterEnd).setHours(23,59,59,999); return this.sortedTransactions.filter(tx => { const txDate = new Date(tx.date).getTime(); return txDate >= start && txDate <= end; }); },
        displayedHistoryTransactions() { if (this.historyTypeFilter === 'all') return this.filteredTransactions; return this.filteredTransactions.filter(tx => tx.type === this.historyTypeFilter); },
        filteredStats() { let realizedPnL = 0, fees = 0, buyAmount = 0, sellAmount = 0; this.filteredTransactions.forEach(tx => { fees += (Number(tx.fee || 0) + Number(tx.tax || 0)); if (tx.type === 'buy') buyAmount += Number(tx.totalAmount || 0); else if (tx.type === 'sell') sellAmount += Number(tx.totalAmount || 0); if (tx.realizedPnL !== null && tx.realizedPnL !== undefined) realizedPnL += Number(tx.realizedPnL) || 0; }); return { realizedPnL, fees, buyAmount, sellAmount }; },
        holdings() { const ordered = [...this.transactions].sort((a, b) => new Date(a.date) - new Date(b.date)); const state = {}; const realized = {}; ordered.forEach(tx => { if (!tx || !tx.code) return; const code = String(tx.code).trim(); if (!state[code]) state[code] = { qty: 0, cost: 0, category: tx.category, name: tx.name }; if (!realized[code]) realized[code] = 0; realized[code] += (tx.realizedPnL !== null && tx.realizedPnL !== undefined) ? Number(tx.realizedPnL) : 0; const qty = Number(tx.qty) || 0; const totalAmount = Number(tx.totalAmount) || 0; if (qty <= 0 || totalAmount < 0) return; // should already be normalized by recompute
                // Update open position state (supports long & short)
                if (tx.type === 'buy') { if (state[code].qty >= 0) { state[code].qty += qty; state[code].cost += totalAmount; } else { const absShort = Math.abs(state[code].qty); const coverQty = Math.min(qty, absShort); const avgEntry = state[code].cost / state[code].qty; const coverAmount = totalAmount * (coverQty / qty); state[code].qty += coverQty; state[code].cost += avgEntry * coverQty; const remain = qty - coverQty; if (remain > 0) { const remainAmount = totalAmount - coverAmount; state[code].qty += remain; state[code].cost += remainAmount; } } } else if (tx.type === 'sell') { if (state[code].qty <= 0) { state[code].qty -= qty; state[code].cost -= totalAmount; } else { const closeQty = Math.min(qty, state[code].qty); const avgEntry = state[code].cost / state[code].qty; const closeAmount = totalAmount * (closeQty / qty); state[code].qty -= closeQty; state[code].cost -= avgEntry * closeQty; const remain = qty - closeQty; if (remain > 0) { const remainAmount = totalAmount - closeAmount; state[code].qty -= remain; state[code].cost -= remainAmount; } } } if (Math.abs(state[code].qty) < 1e-9) { state[code].qty = 0; state[code].cost = 0; } state[code].category = tx.category || state[code].category; state[code].name = tx.name || state[code].name; }); return Object.entries(state).filter(([code, s]) => s.qty !== 0).map(([code, s]) => { const entryAvgPrice = s.cost / s.qty; const currentPrice = this.latestPrices[code] || entryAvgPrice; const absQty = Math.abs(s.qty); const marketValueAbs = currentPrice * absQty; let unrealizedPnL = 0; if (s.qty > 0) { unrealizedPnL = (currentPrice * s.qty) - s.cost; } else { unrealizedPnL = (-s.cost) - marketValueAbs; } const investedBase = Math.abs(s.cost); const roi = investedBase > 0 ? ((unrealizedPnL / investedBase) * 100).toFixed(2) : 0; const status = this.latestStatus[code] || { isWarning: false, disposition: 0 }; return { code, name: s.name, qty: s.qty, category: s.category || 'core', realizedPnL: (realized[code] || 0), totalCost: s.cost, buyAvgPrice: entryAvgPrice, entryAvgPrice, investedBase, currentPrice, unrealizedPnL, roi, isWarning: status.isWarning, disposition: status.disposition }; }).sort((a,b) => (b.category || '').localeCompare(a.category || '') || a.code.localeCompare(b.code)); },
        filteredHoldings() { return this.filter === 'all' ? this.holdings : this.holdings.filter(h => h.category === this.filter); },
        totalInvestedCost() { return this.holdings.reduce((sum, h) => sum + (h.investedBase || 0), 0); },
        estimatedMarketValue() { return this.holdings.reduce((sum, h) => { const price = this.latestPrices[h.code] || h.currentPrice || h.buyAvgPrice || 0; return sum + Math.abs(price * h.qty); }, 0); },
        totalUnrealizedPnL() { return this.holdings.reduce((sum, h) => sum + h.unrealizedPnL, 0); },
        totalRealizedPnL() { return this.transactions.reduce((sum, tx) => sum + ((tx.realizedPnL !== null && tx.realizedPnL !== undefined) ? Number(tx.realizedPnL) : 0), 0); },
        selectedStockBuys() { if (!this.selectedStock) return []; return this.sortedTransactions.filter(tx => tx.code === this.selectedStock.code && tx.type === 'buy').map(tx => ({ id: tx.id, date: tx.date, qty: tx.qty, price: tx.price, category: tx.category })); }
    },
    methods: {
        txTypeLabel(tx) {
            if (!tx) return '';
            if (tx.type === 'buy') {
                if (typeof tx.flow === 'string' && tx.flow.startsWith('cover')) return '回補';
                return '買入';
            }
            if (tx.type === 'sell') {
                const isShort = (typeof tx.flow === 'string' && (tx.flow === 'short' || tx.flow.endsWith('+short') || tx.flow.includes('short')) && !tx.flow.startsWith('sell'));
                if (isShort) return tx.isDayTrade ? '融券賣出(當沖)' : '融券賣出';
                if (tx.flow === 'sell+short') return tx.isDayTrade ? '賣出+融券(當沖)' : '賣出+融券';
                return tx.isDayTrade ? '賣出(當沖)' : '賣出';
            }
            return String(tx.type || '');
        },
        // --- NEW: Analysis Methods ---
        openRealizedDetail(code) { this.realizedDetailCode = code; this.showRealizedDetail = true; },
        closeRealizedDetail() { this.showRealizedDetail = false; this.realizedDetailCode = ''; },

        // --- Existing Methods (Exactly Preserved) ---
        openStockDetails(stock) { if (!stock || !stock.code) return; this.selectedStock = { code: stock.code, name: stock.name }; this.showStockDetails = true; this.currentTab = 'inventory'; window.scrollTo({ top: 0, behavior: 'smooth' }); },
        closeStockDetails() { this.showStockDetails = false; this.selectedStock = null; },
        openEditBuyModal(row) { if (!row || !row.id) { this.openInfoModal('無法編輯', '找不到這筆買入紀錄的識別碼'); return; } const tx = this.transactions.find(t => t.id === row.id); if (!tx) { this.openInfoModal('無法編輯', '找不到對應的交易紀錄'); return; } if (tx.type !== 'buy') { this.openInfoModal('無法編輯', '目前僅支援編輯「買入」紀錄'); return; } this.editBuyTx = { id: tx.id, date: tx.date, code: tx.code, name: tx.name, price: tx.price, qty: tx.qty, category: tx.category || 'core' }; this.showEditBuyModal = true; },
        closeEditBuyModal() { this.showEditBuyModal = false; this.editBuyTx = { id: null, date: '', code: '', name: '', price: null, qty: 0, category: 'core' }; },
        saveEditedBuy() {
            if (!this.editBuyTx.id || !this.editBuyTx.code || !this.editBuyTx.date || !this.editBuyTx.price || !this.editBuyTx.qty) { this.openInfoModal('資料不完整', '請輸入日期、價格與股數'); return; }
            if (this.editBuyTx.qty <= 0 || this.editBuyTx.price <= 0) { this.openInfoModal('資料不正確', '價格與股數需大於 0'); return; }
            const idx = this.transactions.findIndex(t => t.id === this.editBuyTx.id);
            if (idx === -1) { this.openInfoModal('無法儲存', '找不到對應的交易紀錄'); return; }

            const backup = JSON.parse(JSON.stringify(this.transactions));

            const subTotal = this.editBuyTx.price * this.editBuyTx.qty;
            const fee = Math.max(Math.round(subTotal * (this.settings.feeRate / 100) * this.settings.discount), Math.round(this.settings.minFee || 0));
            this.transactions[idx] = { ...this.transactions[idx], date: this.editBuyTx.date, price: this.editBuyTx.price, qty: this.editBuyTx.qty, category: this.editBuyTx.category, fee, tax: 0, totalAmount: subTotal + fee, realizedPnL: null };

            const ok = this.recomputeAllTradesAndValidate();
            if (!ok) { this.transactions = backup; return; }

            this.saveData();
            this.closeEditBuyModal();
            this.openInfoModal('', '買入紀錄已成功更新。');
        },
        openEditTxModal(tx) { if (!tx || !tx.id) { this.openInfoModal('無法編輯', '找不到這筆交易紀錄'); return; } this.editTx = { id: tx.id, date: tx.date, code: tx.code, name: tx.name, type: tx.type, price: Number(tx.price), qty: Number(tx.qty), category: tx.category || 'core', isDayTrade: !!tx.isDayTrade }; this.showEditTxModal = true; },
        closeEditTxModal() { this.showEditTxModal = false; this.editTx = { id: null, date: '', code: '', name: '', type: 'buy', price: null, qty: 0, category: 'core', isDayTrade: false }; },
        saveEditedTxFromHistory() { if (!this.editTx.id || !this.editTx.date || !this.editTx.code || !this.editTx.name) { this.openInfoModal('資料不完整', '請輸入日期、股票代號與名稱'); return; } if (!this.editTx.price || !this.editTx.qty || this.editTx.price <= 0 || this.editTx.qty <= 0) { this.openInfoModal('資料不正確', '價格與股數需大於 0'); return; } const idx = this.transactions.findIndex(t => t.id === this.editTx.id); if (idx === -1) { this.openInfoModal('無法儲存', '找不到對應的交易紀錄'); return; } const backup = JSON.parse(JSON.stringify(this.transactions)); this.transactions[idx] = { ...this.transactions[idx], date: this.editTx.date, code: String(this.editTx.code).trim(), name: String(this.editTx.name).trim(), category: this.editTx.category || this.transactions[idx].category || 'core', price: Number(this.editTx.price), qty: Number(this.editTx.qty), isDayTrade: (this.editTx.type === 'sell' ? !!this.editTx.isDayTrade : false) }; const ok = this.recomputeAllTradesAndValidate(); if (!ok) { this.transactions = backup; return; } this.saveData(); this.closeEditTxModal(); this.openInfoModal('', '交易紀錄已成功更新。'); },
        recomputeAllTradesAndValidate() {
            const ordered = this.sortedTransactions.slice().reverse(); // oldest -> newest
            const state = {};

            for (const tx of ordered) {
                if (!tx || !tx.code) continue;
                const code = String(tx.code).trim();
                tx.code = code;
                if (!state[code]) state[code] = { qty: 0, cost: 0 };

                const qty = Number(tx.qty) || 0;
                const price = Number(tx.price) || 0;
                if (qty <= 0 || price <= 0) {
                    this.openInfoModal('資料錯誤', `交易資料不正確：${tx.name || code} ${tx.date}`);
                    return false;
                }

                const subTotal = price * qty;
                const fee = Math.max(
                    Math.round(subTotal * (this.settings.feeRate / 100) * this.settings.discount),
                    Math.round(this.settings.minFee || 0)
                );

                if (tx.type !== 'buy' && tx.type !== 'sell') tx.type = 'buy';

                // Recompute totals
                if (tx.type === 'buy') {
                    tx.fee = fee;
                    tx.tax = 0;
                    tx.isDayTrade = false;
                    tx.totalAmount = subTotal + fee;
                } else {
                    tx.fee = fee;
                    const taxRate = (tx.isDayTrade ? (this.settings.dayTradeTaxRate ?? 0.15) : this.settings.taxRate);
                    const tax = Math.round(subTotal * (taxRate / 100));
                    tx.tax = tax;
                    tx.totalAmount = subTotal - fee - tax;
                }

                // Reset derived fields (recomputed)
                tx.realizedPnL = null;
                tx.flow = null;
                tx.closedQty = null;
                tx.closedBase = null;

                // Apply to position state (supports long/short + flips)
                if (tx.type === 'buy') {
                    if (state[code].qty >= 0) {
                        state[code].qty += qty;
                        state[code].cost += tx.totalAmount;
                        tx.flow = 'buy';
                    } else {
                        const absShort = Math.abs(state[code].qty);
                        const coverQty = Math.min(qty, absShort);
                        const avgEntry = state[code].cost / state[code].qty; // positive
                        const coverAmount = tx.totalAmount * (coverQty / qty);

                        const pnl = (avgEntry * coverQty) - coverAmount;
                        tx.realizedPnL = pnl;
                        tx.closedQty = coverQty;
                        tx.closedBase = avgEntry * coverQty;
                        tx.flow = (qty > coverQty) ? 'cover+buy' : 'cover';

                        // remove covered portion
                        state[code].qty += coverQty;
                        state[code].cost += avgEntry * coverQty;

                        // remaining opens long
                        const remain = qty - coverQty;
                        if (remain > 0) {
                            const remainAmount = tx.totalAmount - coverAmount;
                            state[code].qty += remain;
                            state[code].cost += remainAmount;
                        }
                    }
                } else {
                    if (state[code].qty <= 0) {
                        state[code].qty -= qty;
                        state[code].cost -= tx.totalAmount;
                        tx.flow = 'short';
                    } else {
                        const closeQty = Math.min(qty, state[code].qty);
                        const avgEntry = state[code].cost / state[code].qty; // positive
                        const closeAmount = tx.totalAmount * (closeQty / qty);

                        const pnl = closeAmount - (avgEntry * closeQty);
                        tx.realizedPnL = pnl;
                        tx.closedQty = closeQty;
                        tx.closedBase = avgEntry * closeQty;
                        tx.flow = (qty > closeQty) ? 'sell+short' : 'sell';

                        // remove sold portion
                        state[code].qty -= closeQty;
                        state[code].cost -= avgEntry * closeQty;

                        // remaining opens short
                        const remain = qty - closeQty;
                        if (remain > 0) {
                            const remainAmount = tx.totalAmount - closeAmount;
                            state[code].qty -= remain;
                            state[code].cost -= remainAmount;
                        }
                    }
                }

                if (Math.abs(state[code].qty) < 1e-9) {
                    state[code].qty = 0;
                    state[code].cost = 0;
                }
            }

            return true;
        },
        handleAuthAction() { this.authError = ''; if (!this.authInput.username || !this.authInput.password) { this.authError = '請輸入帳號與密碼'; return; } if (this.authMode === 'setup') { if (this.authInput.password !== this.authInput.confirmPassword) { this.authError = '兩次密碼輸入不一致'; return; } this.securityConfig = { enabled: true, username: this.authInput.username, passwordHash: btoa(this.authInput.password) }; localStorage.setItem('tw_stock_auth_v1', JSON.stringify(this.securityConfig)); this.isLoggedIn = true; localStorage.setItem('tw_stock_help_autopen_v1', '1'); this.openInfoModal('設定成功', '您的帳號保護已啟用。'); } else { if (this.authInput.username === this.securityConfig.username && btoa(this.authInput.password) === this.securityConfig.passwordHash) { this.isLoggedIn = true; } else { this.authError = '帳號或密碼錯誤'; } } if (this.isLoggedIn) { if (this.rememberUser) { localStorage.setItem('tw_stock_saved_username', this.authInput.username); } else { localStorage.removeItem('tw_stock_saved_username'); } this.authInput.password = ''; this.authInput.confirmPassword = ''; if (!this.rememberUser) this.authInput.username = ''; const shouldAutoOpenHelp = localStorage.getItem('tw_stock_help_autopen_v1') === '1'; const hasSeenHelp = localStorage.getItem('tw_stock_help_seen_v1') === '1'; if (shouldAutoOpenHelp && !hasSeenHelp) { this.showHelpModal = true; localStorage.setItem('tw_stock_help_seen_v1', '1'); localStorage.removeItem('tw_stock_help_autopen_v1'); } } },
        logout() { this.isLoggedIn = false; this.authMode = 'login'; this.showSecurityModal = false; const savedUser = localStorage.getItem('tw_stock_saved_username'); this.authInput.username = savedUser || ''; this.authInput.password = ''; },
        updateSecurityConfig() { localStorage.setItem('tw_stock_auth_v1', JSON.stringify(this.securityConfig)); },
        handleChangePassword() { if (!this.changePassInput.old || !this.changePassInput.new) { this.openInfoModal('錯誤', '欄位不可為空'); return; } if (btoa(this.changePassInput.old) !== this.securityConfig.passwordHash) { this.openInfoModal('錯誤', '舊密碼不正確'); return; } this.securityConfig.passwordHash = btoa(this.changePassInput.new); localStorage.setItem('tw_stock_auth_v1', JSON.stringify(this.securityConfig)); this.changePassInput = { old: '', new: '' }; this.showChangePasswordModal = false; this.openInfoModal('成功', '密碼已變更'); },
        triggerClearAuth() { this.confirmTitle = '清除密碼'; this.confirmMessage = '確定要移除帳號保護嗎？這將會刪除您儲存的登入憑證，下次進入時需重新設定。'; this.confirmCallback = () => { localStorage.removeItem('tw_stock_auth_v1'); localStorage.removeItem('tw_stock_saved_username'); location.reload(); }; this.showConfirmModal = true; },
        forgotPassword() { if(confirm("您確定要重置應用程式並清除密碼嗎？(交易資料保留，但需重新設定帳號)")) { localStorage.removeItem('tw_stock_auth_v1'); location.reload(); } },
        openInfoModal(title, msg) { this.infoTitle = title; this.infoMessage = msg; this.showInfoModal = true; },
        openContextMenu(e, stock) { if (e && typeof e.preventDefault === 'function') e.preventDefault(); this.contextMenu.visible = true; this.contextMenu.x = e?.clientX ?? 0; this.contextMenu.y = e?.clientY ?? 0; this.contextMenu.stock = stock; this.$nextTick(() => { const el = this.$refs.contextMenuEl; if (!el) return; const padding = 8; const vw = window.innerWidth || 0; const vh = window.innerHeight || 0; const rect = el.getBoundingClientRect(); const maxX = Math.max(padding, vw - rect.width - padding); const maxY = Math.max(padding, vh - rect.height - padding); this.contextMenu.x = Math.min(Math.max(this.contextMenu.x, padding), maxX); this.contextMenu.y = Math.min(Math.max(this.contextMenu.y, padding), maxY); }); },
        closeContextMenu() { this.contextMenu.visible = false; },
        handleGlobalClick(e) { if (!this.contextMenu.visible) return; const el = this.$refs.contextMenuEl; if (!el || !el.contains(e.target)) { this.closeContextMenu(); } },
        setManualStatus(disp, warning) { if (!this.contextMenu.stock) return; const code = this.contextMenu.stock.code; this.latestStatus[code] = { isWarning: warning, disposition: disp }; localStorage.setItem('tw_stock_status_v6', JSON.stringify(this.latestStatus)); this.closeContextMenu(); },
        triggerClearHistory() { if (this.transactions.length === 0) { this.openInfoModal('無資料', '目前沒有任何交易紀錄。'); return; } this.confirmTitle = '清空所有紀錄'; this.confirmMessage = '⚠️ 危險操作：您確定要「永久刪除」所有的歷史交易紀錄嗎？此動作執行後將無法復原！'; this.confirmCallback = this.deleteAllTransactions; this.showConfirmModal = true; },
        deleteAllTransactions() { this.transactions = []; this.saveData(); this.openInfoModal('已清空', '所有交易紀錄已成功刪除。'); },
        deleteTransaction(id) { this.confirmTitle = '刪除交易'; this.confirmMessage = '確定要刪除此筆交易紀錄嗎？'; this.confirmCallback = () => { this.transactions = this.transactions.filter(t => t.id !== id); this.saveData(); }; this.showConfirmModal = true; },
        confirmAction() { if (this.confirmCallback) this.confirmCallback(); this.showConfirmModal = false; },
        setDateFilter(mode) { this.dateFilterMode = mode; const today = new Date(); const format = d => d.toISOString().split('T')[0]; this.filterEnd = format(today); if (mode === 'today') this.filterStart = format(today); else if (mode === 'yesterday') { const y = new Date(); y.setDate(y.getDate() - 1); this.filterStart = format(y); this.filterEnd = format(y); } else if (mode === 'week') { const d = new Date(); d.setDate(d.getDate() - 6); this.filterStart = format(d); } else if (mode === 'month') { const d = new Date(); d.setMonth(d.getMonth() - 1); this.filterStart = format(d); } else if (mode === 'all') this.filterStart = '2000-01-01'; },
        async fetchStockPrices() { if (this.holdings.length === 0) { this.openInfoModal('無庫存可更新', '目前沒有持倉股票，請先新增交易。'); return; } this.isLoading = true; this.lastPriceUpdateError = ''; this.lastPriceUpdateAttemptTs = Date.now(); localStorage.setItem('tw_stock_price_update_attempt_ts_v1', String(this.lastPriceUpdateAttemptTs)); localStorage.setItem('tw_stock_price_update_error_v1', ''); const proxyUrl = (location.protocol === 'file:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? "https://corsproxy.io/?" : "/.netlify/functions/yahoo?u="; const promises = this.holdings.map(async (stock) => { const code = stock.code; let price = null; let status = this.latestStatus[code] || { isWarning: false, disposition: 0 }; try { const res = await fetch(`${proxyUrl}${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${code}.TW?interval=1d`)}`); const data = await res.json(); if (data.chart && data.chart.result) price = data.chart.result[0].meta.regularMarketPrice; } catch(e) {} if (price === null) { try { const res = await fetch(`${proxyUrl}${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${code}.TWO?interval=1d`)}`); const data = await res.json(); if (data.chart && data.chart.result) price = data.chart.result[0].meta.regularMarketPrice; } catch(e) {} } try { const pageRes = await fetch(`${proxyUrl}${encodeURIComponent(`https://tw.stock.yahoo.com/quote/${code}`)}`); const htmlText = await pageRes.text(); if (htmlText.match(/處置|彈性處置/)) { status.disposition = 5; if (htmlText.match(/20分鐘|二十分鐘|20分/)) { status.disposition = 20; } } if (htmlText.match(/注意|警示/)) { status.isWarning = true; } } catch(e) { console.log('Status fetch failed for', code, e); } return { code, price, status }; }); try { const results = await Promise.all(promises); let updatedCount = 0; let missingCount = 0; results.forEach(res => { if (res.price !== null && res.price !== undefined && !Number.isNaN(Number(res.price))) { this.latestPrices[res.code] = Number(res.price); updatedCount += 1; } else { missingCount += 1; } this.latestStatus[res.code] = res.status; }); if (updatedCount === 0) throw new Error('NO_PRICE_UPDATED'); const now = new Date(); this.lastUpdateTime = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`; this.lastUpdateTimestamp = now.getTime(); localStorage.setItem('tw_stock_prices_v6', JSON.stringify(this.latestPrices)); localStorage.setItem('tw_stock_status_v6', JSON.stringify(this.latestStatus)); localStorage.setItem('tw_stock_time_v6', this.lastUpdateTime); localStorage.setItem('tw_stock_time_ts_v6', String(this.lastUpdateTimestamp)); this.lastPriceUpdatePartial = (missingCount > 0); this.lastPriceUpdateMissingCount = missingCount; localStorage.setItem('tw_stock_price_update_partial_v1', this.lastPriceUpdatePartial ? '1' : '0'); localStorage.setItem('tw_stock_price_update_missing_count_v1', String(this.lastPriceUpdateMissingCount)); if (missingCount > 0) { this.openInfoModal('部分更新成功', ` ${updatedCount} 檔，${missingCount} 檔未更新（沿用上次價格）。`); } else { this.openInfoModal('更新成功', '股價與警示狀態已同步！'); } } catch (error) { this.lastPriceUpdateError = '連線不穩定或資料來源暫時不可用，已沿用上次價格。'; localStorage.setItem('tw_stock_price_update_error_v1', this.lastPriceUpdateError); this.lastPriceUpdatePartial = false; this.lastPriceUpdateMissingCount = 0; localStorage.setItem('tw_stock_price_update_partial_v1', '0'); localStorage.setItem('tw_stock_price_update_missing_count_v1', '0'); this.openInfoModal('', '連線不穩定，已沿用上次價格。可稍後再試。'); } finally { this.isLoading = false; } },
        async fetchGlobalIndices() { this.isGlobalLoading = true; this.showGlobalIndices = true; this.globalIndices = []; const corsBase = (location.protocol === 'file:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? "https://corsproxy.io/?" : "/.netlify/functions/yahoo?u="; const cors = (url) => `${corsBase}${encodeURIComponent(url)}`; const fetchFromYahooChart = async (symbol) => { const encodedSymbol = encodeURIComponent(symbol); const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodedSymbol}?interval=1d`; const res = await fetch(cors(url)); if (!res.ok) throw new Error(`HTTP ${res.status}`); const data = await res.json(); const meta = data?.chart?.result?.[0]?.meta; const price = meta?.regularMarketPrice; const prev = meta?.chartPreviousClose ?? meta?.previousClose; if (typeof price !== 'number' || typeof prev !== 'number' || prev === 0) throw new Error('No market meta'); const change = price - prev; const percent = (change / prev) * 100; return { price, change, percent }; }; const fetchTaiexNightFromYahooTW = async () => { const url = `https://tw.stock.yahoo.com/future/futures.html`; const res = await fetch(cors(url)); if (!res.ok) throw new Error(`HTTP ${res.status}`); const htmlText = await res.text(); const idx = htmlText.indexOf('WTX&'); const idx2 = htmlText.indexOf('WTX&amp;'); const hit = (idx !== -1) ? idx : idx2; if (hit === -1) throw new Error('WTX& not found'); const slice = htmlText.slice(Math.max(0, hit - 4000), Math.min(htmlText.length, hit + 8000)); const textOnly = slice.replace(/<script[\s\S]*?<\/script>/gi, ' ').replace(/<style[\s\S]*?<\/style>/gi, ' ').replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim(); const m = textOnly.match(/(-?\d{1,3}(?:,\d{3})*(?:\.\d+)?)\s*([+-]?\d+(?:\.\d+)?)%/); const change = m ? parseFloat(m[1].replace(/,/g, '')) : null; const percent = m ? parseFloat(m[2]) : null; const after = textOnly.split(/WTX&|WTX&amp;/).slice(1).join(' ').trim(); const numsAfter = after.match(/-?\d{1,3}(?:,\d{3})*(?:\.\d+)?/g) || []; const price = numsAfter.length ? parseFloat(numsAfter[0].replace(/,/g, '')) : null; if (typeof price !== 'number' || isNaN(price)) throw new Error('No price parsed'); return { price, change: (typeof change === 'number' && !isNaN(change)) ? change : 0, percent: (typeof percent === 'number' && !isNaN(percent)) ? percent : 0 }; }; const targets = [ { symbol: '^DJI', name: '道瓊工業', kind: 'chart' }, { symbol: '^IXIC', name: 'NASDAQ', kind: 'chart' }, { symbol: '^GSPC', name: 'S&P 500', kind: 'chart' }, { symbol: '^SOX', name: '費城半導體', kind: 'chart' }, { symbol: 'WTX&', name: '台股指數(夜盤)', kind: 'taiexNight' }, ]; const promises = targets.map(async (t) => { try { const { price, change, percent } = (t.kind === 'taiexNight') ? await fetchTaiexNightFromYahooTW() : await fetchFromYahooChart(t.symbol); return { ...t, price: Number(price).toFixed(2), change, percent }; } catch (e) { return { ...t, price: '-', change: 0, percent: 0 }; } }); const results = await Promise.all(promises); this.globalIndices = results; const missing = results.filter(x => x && x.price === '-').length; const total = results.length; const success = total - missing; this.globalIndicesAttemptTs = Date.now(); localStorage.setItem('tw_stock_global_update_attempt_ts_v1', String(this.globalIndicesAttemptTs)); if (success <= 0) { this.globalIndicesError = true; this.globalIndicesPartial = false; this.globalIndicesMissingCount = total; localStorage.setItem('tw_stock_global_update_error_v1', '1'); localStorage.setItem('tw_stock_global_update_partial_v1', '0'); localStorage.setItem('tw_stock_global_update_missing_count_v1', String(this.globalIndicesMissingCount)); } else { this.globalIndicesLastTs = Date.now(); localStorage.setItem('tw_stock_global_time_ts_v1', String(this.globalIndicesLastTs)); this.globalIndicesError = false; this.globalIndicesPartial = (missing > 0); this.globalIndicesMissingCount = missing; localStorage.setItem('tw_stock_global_update_error_v1', '0'); localStorage.setItem('tw_stock_global_update_partial_v1', this.globalIndicesPartial ? '1' : '0'); localStorage.setItem('tw_stock_global_update_missing_count_v1', String(this.globalIndicesMissingCount)); } this.isGlobalLoading = false; },
        async fetchTaiexNightIndex() { this.isTaiexNightLoading = true; this.showGlobalIndices = true; const corsBase = (location.protocol === 'file:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? "https://corsproxy.io/?" : "/.netlify/functions/yahoo?u="; const cors = (url) => `${corsBase}${encodeURIComponent(url)}`; try { const url = `https://tw.stock.yahoo.com/future/futures.html`; const res = await fetch(cors(url)); if (!res.ok) throw new Error(`HTTP ${res.status}`); const htmlText = await res.text(); const idx = htmlText.indexOf('WTX&'); const idx2 = htmlText.indexOf('WTX&amp;'); const hit = (idx !== -1) ? idx : idx2; if (hit === -1) throw new Error('WTX& not found'); const slice = htmlText.slice(Math.max(0, hit - 4000), Math.min(htmlText.length, hit + 8000)); const textOnly = slice.replace(/<script[\s\S]*?<\/script>/gi, ' ').replace(/<style[\s\S]*?<\/style>/gi, ' ').replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim(); const m = textOnly.match(/(-?\d{1,3}(?:,\d{3})*(?:\.\d+)?)\s*([+-]?\d+(?:\.\d+)?)%/); const change = m ? parseFloat(m[1].replace(/,/g, '')) : 0; const percent = m ? parseFloat(m[2]) : 0; const after = textOnly.split(/WTX&|WTX&amp;/).slice(1).join(' ').trim(); const numsAfter = after.match(/-?\d{1,3}(?:,\d{3})*(?:\.\d+)?/g) || []; const price = numsAfter.length ? parseFloat(numsAfter[0].replace(/,/g, '')) : null; if (typeof price !== 'number' || isNaN(price)) throw new Error('No price parsed'); if (!Array.isArray(this.globalIndices) || this.globalIndices.length === 0) { await this.fetchGlobalIndices(); this.isTaiexNightLoading = false; return; } const i = this.globalIndices.findIndex(x => x.kind === 'taiexNight' || x.symbol === 'WTX&'); const item = { symbol: 'WTX&', name: '台股指數(夜盤)', kind: 'taiexNight', price: Number(price).toFixed(2), change: (typeof change === 'number' && !isNaN(change)) ? change : 0, percent: (typeof percent === 'number' && !isNaN(percent)) ? percent : 0 }; if (i >= 0) this.$set ? this.$set(this.globalIndices, i, item) : (this.globalIndices.splice(i, 1, item)); else this.globalIndices.push(item); this.globalIndicesLastTs = Date.now(); localStorage.setItem('tw_stock_global_time_ts_v1', String(this.globalIndicesLastTs)); const missing = (this.globalIndices || []).filter(x => x && x.price === '-').length; const total = (this.globalIndices || []).length; const success = total - missing; this.globalIndicesError = (success <= 0); this.globalIndicesPartial = (!this.globalIndicesError && missing > 0); this.globalIndicesMissingCount = missing; localStorage.setItem('tw_stock_global_update_error_v1', this.globalIndicesError ? '1' : '0'); localStorage.setItem('tw_stock_global_update_partial_v1', this.globalIndicesPartial ? '1' : '0'); localStorage.setItem('tw_stock_global_update_missing_count_v1', String(this.globalIndicesMissingCount)); } catch (e) { const i = this.globalIndices.findIndex(x => x.kind === 'taiexNight' || x.symbol === 'WTX&'); if (i >= 0) { const cur = this.globalIndices[i]; const next = { ...cur, price: '-', change: 0, percent: 0 }; this.globalIndices.splice(i, 1, next); } const missing = (this.globalIndices || []).filter(x => x && x.price === '-').length; const total = (this.globalIndices || []).length; const success = total - missing; this.globalIndicesError = (success <= 0); this.globalIndicesPartial = (!this.globalIndicesError && missing > 0); this.globalIndicesMissingCount = missing; localStorage.setItem('tw_stock_global_update_error_v1', this.globalIndicesError ? '1' : '0'); localStorage.setItem('tw_stock_global_update_partial_v1', this.globalIndicesPartial ? '1' : '0'); localStorage.setItem('tw_stock_global_update_missing_count_v1', String(this.globalIndicesMissingCount)); } finally { this.isTaiexNightLoading = false; } },
        lookupStock() { const term = this.searchText; if (!term) { this.suggestions = []; this.showSuggestions = false; return; } const localResults = this.fullStockMap.filter(s => s.code.startsWith(term) || s.name.includes(term)); this.suggestions = localResults.slice(0, 6); this.showSuggestions = true; const exact = localResults.find(s => s.code === term || s.name === term); if(exact) { this.newTx.code = exact.code; this.newTx.name = exact.name; } if (term.length > 1 && localResults.length < 3) { if (this.searchTimeout) clearTimeout(this.searchTimeout); this.searchTimeout = setTimeout(() => { this.fetchOnlineSuggestions(term); }, 500); } },
        async fetchOnlineSuggestions(query) { this.isSearching = true; try { const res = await fetch(`${((location.protocol === 'file:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? "https://corsproxy.io/?" : "/.netlify/functions/yahoo?u=")}${encodeURIComponent(`https://query1.finance.yahoo.com/v1/finance/search?q=${query}&lang=zh-Hant-TW&region=TW&quotesCount=5&newsCount=0`)}`); const data = await res.json(); if (data.quotes && data.quotes.length > 0) { const onlineResults = data.quotes.filter(q => q.symbol && (q.symbol.endsWith('.TW') || q.symbol.endsWith('.TWO'))).map(q => ({ code: q.symbol.replace(/\.TW(O)?$/, ''), name: q.longname || q.shortname || '', isOnline: true })); const existingCodes = new Set(this.suggestions.map(s => s.code)); onlineResults.forEach(item => { if (!existingCodes.has(item.code)) this.suggestions.push(item); }); } } catch (e) {} finally { this.isSearching = false; } },
        selectSuggestion(stock) { this.searchText = stock.code + " " + stock.name; this.newTx.code = stock.code; this.newTx.name = stock.name; this.showSuggestions = false; },
        addTransaction() {
            if (!this.newTx.code || !this.newTx.price || !this.newTx.qty) { this.openInfoModal('資料不完整', '請輸入代碼、價格與股數'); return; }
            const type = (this.newTx.type === 'sell') ? 'sell' : 'buy';
            const code = String(this.newTx.code).trim();
            const name = String(this.newTx.name || '').trim();
            const price = Number(this.newTx.price);
            const qty = Number(this.newTx.qty);
            if (!price || !qty || price <= 0 || qty <= 0) { this.openInfoModal('資料錯誤', '請輸入正確價格與股數'); return; }

            const exists = this.fullStockMap.find(s => s.code === code);
            if (!exists && name) {
                this.customStocks.push({ code, name });
                localStorage.setItem('tw_stock_custom_v6', JSON.stringify(this.customStocks));
            }
            this.latestPrices[code] = price;

            const subTotal = price * qty;
            const fee = Math.max(Math.round(subTotal * (this.settings.feeRate / 100) * this.settings.discount), Math.round(this.settings.minFee || 0));

            let tax = 0;
            let totalAmount = subTotal + fee;
            let isDayTrade = false;
            if (type === 'sell') {
                isDayTrade = !!this.newTx.isDayTrade;
                const taxRate = (isDayTrade ? (this.settings.dayTradeTaxRate ?? 0.15) : this.settings.taxRate);
                tax = Math.round(subTotal * (taxRate / 100));
                totalAmount = subTotal - fee - tax;
            }

            const backup = JSON.parse(JSON.stringify(this.transactions));
            this.transactions.push({ id: Date.now(), date: this.newTx.date, code, name: name || (exists ? exists.name : code), type, price, qty, category: this.newTx.category, isDayTrade, fee, tax, totalAmount, realizedPnL: null });

            const ok = this.recomputeAllTradesAndValidate();
            if (!ok) { this.transactions = backup; return; }

            this.saveData();
            this.newTx.price = null;
            this.searchText = '';
            this.newTx.isDayTrade = false;
            this.showAddModal = false;
            this.openInfoModal('新增成功', '交易紀錄已儲存！');
        },
        openSellModal(stock) {
            if (!stock || !stock.code) return;
            // Inventory sell modal is for closing long positions. For shorts, use the top trade form.
            if (Number(stock.qty) <= 0) {
                this.openInfoModal('空單持倉', '此標的是空單（負庫存）。回補請用上方「新增交易紀錄」選買入/回補；要加空請選賣出/做空。');
                return;
            }
            this.sellTx = {
                date: new Date().toISOString().split('T')[0],
                code: stock.code,
                name: stock.name,
                price: this.latestPrices[stock.code] || stock.currentPrice || null,
                qty: Math.abs(stock.qty),
                maxQty: Math.abs(stock.qty),
                category: stock.category,
                isDayTrade: false
            };
            this.showSellModal = true;
        },
        confirmSell() {
            if(!this.sellTx.price || !this.sellTx.qty || this.sellTx.qty <= 0) { this.openInfoModal('資料錯誤', '請輸入正確價格與股數'); return; }
            if(this.sellTx.maxQty && this.sellTx.qty > this.sellTx.maxQty) { this.openInfoModal('庫存不足', '賣出股數不可大於庫存'); return; }

            const subTotal = this.sellTx.price * this.sellTx.qty;
            const fee = Math.max(Math.round(subTotal * (this.settings.feeRate / 100) * this.settings.discount), Math.round(this.settings.minFee || 0));
            const taxRate = (this.sellTx.isDayTrade ? (this.settings.dayTradeTaxRate ?? 0.15) : this.settings.taxRate);
            const tax = Math.round(subTotal * (taxRate / 100));
            const totalAmount = subTotal - fee - tax;

            const backup = JSON.parse(JSON.stringify(this.transactions));
            this.transactions.push({ id: Date.now(), date: this.sellTx.date, code: this.sellTx.code, name: this.sellTx.name, type: 'sell', price: Number(this.sellTx.price), qty: Number(this.sellTx.qty), category: this.sellTx.category, isDayTrade: !!this.sellTx.isDayTrade, fee, tax, totalAmount, realizedPnL: null });

            const ok = this.recomputeAllTradesAndValidate();
            if (!ok) { this.transactions = backup; return; }

            this.saveData();
            this.showSellModal = false;
        },
        saveSettings() { localStorage.setItem('tw_stock_settings_v6', JSON.stringify(this.settings)); this.showSettings = false; },
        saveData() { localStorage.setItem('tw_stock_tx_v6', JSON.stringify(this.transactions)); },
        exportData() { const dateStr = new Date().toISOString().split('T')[0]; this.exportFileName = `stock_backup_${dateStr}`; this.backupTab = 'download'; this.restoreFileName = ''; this.restoreFileObject = null; this.showExportModal = true; },
        confirmExport() { const dataStr = JSON.stringify({ tx: this.transactions, settings: this.settings, custom: this.customStocks, prices: this.latestPrices, time: this.lastUpdateTime }); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${this.exportFileName || 'backup'}.json`; a.click(); this.showExportModal = false; },
        onRestoreBackupFileChange(e) { const file = e?.target?.files?.[0]; if (!file) return; this.restoreFileName = file.name || ''; this.restoreFileObject = file; },
        async confirmRestoreFromBackupFile() { if (!this.restoreFileObject) return; this.restoreBusy = true; try { const file = this.restoreFileObject; const text = await file.text(); let payload; try { payload = JSON.parse(text); } catch (err) { throw new Error('備份檔案不是有效的 JSON 格式。'); } this._applyBackupPayload(payload); this.openInfoModal('還原成功', '已從備份檔案還原資料，將重新整理以套用所有狀態。'); setTimeout(() => window.location.reload(), 600); } catch (e) { this.openInfoModal('還原失敗', `發生未預期錯誤：${e?.message || e}`); } finally { this.restoreBusy = false; } },
        _applyBackupPayload(payload) { if (!payload || typeof payload !== 'object') throw new Error('備份檔內容格式不正確。'); const tx = Array.isArray(payload.tx) ? payload.tx : []; const settings = payload.settings && typeof payload.settings === 'object' ? payload.settings : this.settings; const custom = Array.isArray(payload.custom) ? payload.custom : []; const prices = payload.prices && typeof payload.prices === 'object' ? payload.prices : {}; const status = payload.status && typeof payload.status === 'object' ? payload.status : (this.latestStatus || {}); const time = typeof payload.time === 'string' ? payload.time : ''; this.transactions = tx; this.settings = settings; this.customStocks = custom; this.latestPrices = prices; this.latestStatus = status; this.lastUpdateTime = time; localStorage.setItem('tw_stock_tx_v6', JSON.stringify(tx)); localStorage.setItem('tw_stock_settings_v6', JSON.stringify(settings)); localStorage.setItem('tw_stock_custom_v6', JSON.stringify(custom)); localStorage.setItem('tw_stock_prices_v6', JSON.stringify(prices)); localStorage.setItem('tw_stock_status_v6', JSON.stringify(status)); localStorage.setItem('tw_stock_time_v6', time); try { this.recomputeAllTradesAndValidate(); } catch (_) {} },
        _readCloudMeta() { try { return JSON.parse(localStorage.getItem('tw_stock_cloud_meta_v1') || '{}') || {}; } catch(e) { return {}; } },
        _writeCloudMeta(patch) { const cur = this._readCloudMeta(); const next = Object.assign({}, cur, patch || {}); localStorage.setItem('tw_stock_cloud_meta_v1', JSON.stringify(next)); this.gdriveCloudMeta = next; },
        formatDateTime(ts) { if (!ts) return '—'; const d = new Date(ts); if (isNaN(d.getTime())) return '—'; try { return d.toLocaleString('zh-TW', { hour12: false }); } catch (_) { return d.toLocaleString(); } },
        async refreshGDriveCloudMeta() { this.gdriveBusy = true; this.gdriveBusyText = '正在取得雲端狀態…'; try { const accessToken = await this._ensureGDriveAccessToken(); const info = await this._findBackupFileId(accessToken); if (!info) { this._writeCloudMeta({ cloudFileModifiedTime: '', cloudFileExists: false }); this.openInfoModal('雲端狀態', '雲端目前沒有找到備份檔（tw_stock_backup.json）。'); return; } this._writeCloudMeta({ cloudFileExists: true, cloudFileModifiedTime: info.modifiedTime || '' }); this.openInfoModal('雲端狀態', '雲端最後修改時間。'); } catch(e) { this.openInfoModal('雲端狀態', `發生未預期錯誤：${e?.message || e}`); } finally { this.gdriveBusy = false; this.gdriveBusyText = ''; } },
        saveGDriveClientId() { const cid = (this.gdriveClientIdInput || '').trim(); if (!cid) { this.openInfoModal('提示', '請先輸入 Google OAuth Client ID。'); return; } localStorage.setItem('tw_stock_gdrive_client_id_v1', cid); this.gdriveClientId = cid; this.openInfoModal('已儲存', 'Google OAuth Client ID 已儲存。'); },
        clearGDriveClientId() { localStorage.removeItem('tw_stock_gdrive_client_id_v1'); this.gdriveClientId = ''; this.gdriveClientIdInput = ''; this.openInfoModal('已清除', '已清除 Google OAuth Client ID。'); },
        async _ensureGDriveAccessToken() { const cid = (this.gdriveClientId || '').trim(); if (!cid) throw new Error('缺少 Google OAuth Client ID。'); if (!window.google || !google.accounts || !google.accounts.oauth2) { throw new Error('Google Identity Services 尚未載入，請稍後再試。'); } if (!__gdriveTokenClient || __gdriveTokenClientCid !== cid) { __gdriveTokenClient = google.accounts.oauth2.initTokenClient({ client_id: cid, scope: __GDRIVE_SCOPE, callback: () => {} }); __gdriveTokenClientCid = cid; } const token = await new Promise((resolve, reject) => { let finished = false; const timer = setTimeout(() => { if (finished) return; finished = true; reject(new Error('授權逾時。請確認已允許彈出視窗（Popup），並在 https 網域下使用。')); }, 10000); __gdriveTokenClient.callback = (resp) => { if (finished) return; finished = true; clearTimeout(timer); if (resp && resp.access_token) resolve(resp.access_token); else reject(new Error(resp?.error_description || resp?.error || '授權失敗')); }; try { __gdriveTokenClient.requestAccessToken({ prompt: 'consent' }); } catch (e) { if (finished) return; finished = true; clearTimeout(timer); reject(new Error('無法啟動授權流程。請允許彈出視窗（Popup）後再試一次。')); } }); return token; },
        async _findBackupFileId(accessToken) { const q = encodeURIComponent("name='tw_stock_backup.json' and 'appDataFolder' in parents and trashed=false"); const url = `https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&q=${q}&fields=files(id,name,modifiedTime)&pageSize=1`; const res = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` }}); if (!res.ok) throw new Error(`Drive 查詢失敗（${res.status}）`); const j = await res.json(); return (j.files && j.files[0] && j.files[0].id) ? { id: j.files[0].id, modifiedTime: j.files[0].modifiedTime || '' } : null; },
        _buildBackupPayload() { return { tx: this.transactions, settings: this.settings, custom: this.customStocks, prices: this.latestPrices, status: this.latestStatus, time: this.lastUpdateTime, version: 1, exportedAt: new Date().toISOString() }; },
        async uploadToGDrive() { this.gdriveBusy = true; this.gdriveBusyText = '正在授權／連線…'; try { const accessToken = await this._ensureGDriveAccessToken(); const payload = this._buildBackupPayload(); const fileInfo = await this._findBackupFileId(accessToken); const fileId = fileInfo && fileInfo.id ? fileInfo.id : null; const boundary = '-------314159265358979323846'; const metadata = fileId ? { name: 'tw_stock_backup.json' } : { name: 'tw_stock_backup.json', parents: ['appDataFolder'] }; const multipartBody = `--${boundary}\r\n` + `Content-Type: application/json; charset=UTF-8\r\n\r\n` + `${JSON.stringify(metadata)}\r\n` + `--${boundary}\r\n` + `Content-Type: application/json; charset=UTF-8\r\n\r\n` + `${JSON.stringify(payload)}\r\n` + `--${boundary}--`; const uploadUrl = fileId ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart&fields=id,modifiedTime` : `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,modifiedTime`; const method = fileId ? 'PATCH' : 'POST'; const res = await fetch(uploadUrl, { method, headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': `multipart/related; boundary=${boundary}` }, body: multipartBody }); if (!res.ok) { const t = await res.text().catch(()=>''); throw new Error(`上傳失敗（${res.status}）${t ? '：' + t : ''}`); } let uploadInfo = null; try { uploadInfo = await res.json(); } catch(_) { uploadInfo = null; } const nowIso = new Date().toISOString(); this._writeCloudMeta({ lastCloudUploadAt: nowIso, lastAction: 'upload', cloudFileExists: true, cloudFileModifiedTime: (uploadInfo && uploadInfo.modifiedTime) ? uploadInfo.modifiedTime : (fileInfo && fileInfo.modifiedTime ? fileInfo.modifiedTime : '') }); this.openInfoModal('上傳成功', '已將資料備份到 Google 雲端。'); } catch (e) { this.openInfoModal('上傳失敗', `發生未預期錯誤：${e?.message || e}`); } finally { this.gdriveBusy = false; this.gdriveBusyText = ''; } },
        async restoreFromGDrive() { this.gdriveBusy = true; this.gdriveBusyText = '正在授權／下載備份…'; try { const accessToken = await this._ensureGDriveAccessToken(); const fileInfo = await this._findBackupFileId(accessToken); const fileId = fileInfo && fileInfo.id ? fileInfo.id : null; if (!fileId) { this.openInfoModal('回復失敗', '雲端找不到備份檔案（tw_stock_backup.json）。'); return; } const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`; const res = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` }}); if (!res.ok) throw new Error(`下載失敗（${res.status}）`); const payload = await res.json(); if (!payload || typeof payload !== 'object') throw new Error('備份檔內容格式不正確。'); const tx = Array.isArray(payload.tx) ? payload.tx : []; const settings = payload.settings && typeof payload.settings === 'object' ? payload.settings : this.settings; const custom = Array.isArray(payload.custom) ? payload.custom : []; const prices = payload.prices && typeof payload.prices === 'object' ? payload.prices : {}; const status = payload.status && typeof payload.status === 'object' ? payload.status : {}; const time = typeof payload.time === 'string' ? payload.time : ''; this.transactions = tx; this.settings = settings; this.customStocks = custom; this.latestPrices = prices; this.latestStatus = status; this.lastUpdateTime = time; localStorage.setItem('tw_stock_tx_v6', JSON.stringify(tx)); localStorage.setItem('tw_stock_settings_v6', JSON.stringify(settings)); localStorage.setItem('tw_stock_custom_v6', JSON.stringify(custom)); localStorage.setItem('tw_stock_prices_v6', JSON.stringify(prices)); localStorage.setItem('tw_stock_status_v6', JSON.stringify(status)); localStorage.setItem('tw_stock_time_v6', time); const nowIso = new Date().toISOString(); this._writeCloudMeta({ lastCloudRestoreAt: nowIso, lastAction: 'restore', cloudFileExists: true, cloudFileModifiedTime: (fileInfo && fileInfo.modifiedTime) ? fileInfo.modifiedTime : (this.gdriveCloudMeta && this.gdriveCloudMeta.cloudFileModifiedTime ? this.gdriveCloudMeta.cloudFileModifiedTime : '') }); this.openInfoModal('回復成功', '已從雲端回復資料，將重新整理以套用所有狀態。'); setTimeout(() => window.location.reload(), 600); } catch (e) { this.openInfoModal('回復失敗', `發生未預期錯誤：${e?.message || e}`); } finally { this.gdriveBusy = false; this.gdriveBusyText = ''; } },
        formatPrice2(val) { const num = Number(val); if (!Number.isFinite(num)) return '0.00'; const fixed = num.toFixed(2); const parts = fixed.split('.'); const intPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ","); return intPart + '.' + (parts[1] || '00'); },
        formatCurrency(val) { return Math.round(val || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    }
}).mount('#app');
</script>
</body>
</html>